<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0c10" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="apple-touch-icon" sizes="180x180" href="icons/icon-180.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192-rounded.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="icons/icon-512-rounded.png" />
  <link rel="manifest" href="/Tuttorly-Lite/manifest.webmanifest" />
  <title>Tuttorly ‚Äî Minimal Demo</title>
  <style>
    :root{
      --bg:#0b0c10;
      --phone:#111216;
      --card:#181a1f;
      --muted:#9aa3ad;
      --text:#e9ecf1;
      --accent:#5dd7ef;
      --accent-2:#8b5cf6;
      --danger:#ef4444;
      --ok:#22c55e;
      --okbg:rgba(34,197,94,.12);
      --okbor:rgba(34,197,94,.45);
      --dangbg:rgba(239,68,68,.12);
      --dangbor:rgba(239,68,68,.45);
      --border:rgba(255,255,255,0.08);
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --goodbg:rgba(34,197,94,.12);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:radial-gradient(1200px 800px at 10% 10%,rgba(139,92,246,.25),transparent),
                           radial-gradient(900px 700px at 90% 80%,rgba(110,231,255,.2),transparent),
                           var(--bg);
      color:var(--text); font:500 16px/1.4 system-ui, Segoe UI, Roboto, Inter, Arial;
      display:grid; place-items:center; padding:24px;
      overflow:hidden;
      user-select:none;
      -webkit-user-select:none;
      -moz-user-select:none;
      -ms-user-select:none;
    }

    /* SPLASH */
    .splash{position:fixed; inset:0; display:grid; place-items:center; z-index:20;
      background:radial-gradient(1200px 800px at 10% 10%,rgba(139,92,246,.25),transparent),
                 radial-gradient(900px 700px at 90% 80%,rgba(110,231,255,.2),transparent),
                 var(--bg);
      animation: splashFade 1.2s ease 1.2s forwards;
    }
    .splash-logo{font-weight:900; font-size:48px; letter-spacing:.6px;
      background:linear-gradient(135deg, #d4d4d8 0%, #e4e4e7 50%, #d4d4d8 100%);
      -webkit-background-clip:text; background-clip:text; color:transparent;
      animation: popIn .8s ease;
    }
    @keyframes popIn{from{transform:scale(.9); opacity:0} to{transform:scale(1); opacity:1}}
    @keyframes splashFade{to{opacity:0; visibility:hidden}}

    /* PHONE MOCKUP */
    .phone{ width:380px; height:760px; background:var(--phone);
      border-radius:40px; position:relative; box-shadow:var(--shadow);
      border:1px solid var(--border); padding:18px; display:flex; flex-direction:column;
      opacity:0; transition:opacity .6s ease; }
    .phone.show{opacity:1}
    .notch{position:absolute; top:10px; left:50%; transform:translateX(-50%);
      width:140px; height:22px; background:#0c0d11; border-radius:0 0 14px 14px; border:1px solid var(--border);}    
    .screen{flex:1; background:linear-gradient(180deg,#0f1117, #0c0e12 60%);
      border-radius:28px; padding:16px; overflow:auto; display:flex; flex-direction:column; border:1px solid var(--border); scroll-behavior:smooth; scrollbar-width:none;}
    .screen::-webkit-scrollbar{display:none}

    /* APP CHROME */
    .appbar{display:flex; align-items:center; gap:10px; padding:2px 6px 6px 6px; justify-content:space-between}
    .appbar-left{display:flex; align-items:center; gap:10px; flex:0}
    .appbar-center{display:flex; align-items:center; justify-content:center; flex:1}
    .appbar-right{display:flex; align-items:center; gap:10px; flex:0}
    .logo{width:28px; height:28px; border-radius:9px; background:linear-gradient(145deg,#1a2847,#0f1626); display:grid; place-items:center; font-weight:800; color:var(--text)}
    .title{font-weight:800; letter-spacing:.2px; color:var(--text); font-size:18px}
    .spacer{flex:1}
    .iconbtn{width:38px; height:38px; border-radius:12px; display:grid; place-items:center; cursor:pointer; border:1px solid var(--border); background:#151821}
    .iconbtn svg{width:18px; height:18px; fill:currentColor; color:var(--text)}
    .iconbtn.ghost{background:transparent}
    .iconbtn.primary{
      /* Upodobnione do FAB (+) */
      background:linear-gradient(145deg, #1a2847, #0f1626);
      border:none;
      border-radius:14px;
      color:var(--text);
      box-shadow:0 10px 22px rgba(0,0,0,.35);
      transition:transform .08s ease, filter .15s ease;
    }
    .iconbtn.primary svg{color:var(--text)}
    .iconbtn.primary:hover{filter:brightness(1.05)}
    .iconbtn.primary:active{transform:scale(.97)} 

    /* BADGE */
    .tabs{display:flex; gap:8px; margin:8px 0 12px; cursor:pointer}
    .tab{flex:1; text-align:center; padding:10px; border-radius:12px; border:1px solid var(--border); color:var(--muted); cursor:pointer; transition:all .15s ease}
    .tab:hover{background:rgba(255,255,255,.04)}
    .tab.active{background:linear-gradient(180deg,rgba(139,92,246,.17),rgba(110,231,255,.12)); color:var(--text)}

    /* VIEWS */
    .view{display:none !important; flex-direction:column; gap:10px; flex:1; overflow:auto; animation:fadeIn .3s ease}
    .view.active{display:flex !important}
    @keyframes fadeIn{from{opacity:0; transform:translateY(8px)} to{opacity:1; transform:translateY(0)}}
    
    /* Smooth transitions for swipe navigation */
    .phone{transition:none}
    .view{transition:opacity .3s ease, transform .3s ease}

    /* LIST */
    .list{display:flex; flex-direction:column; gap:10px; overflow:visible; padding-right:4px; padding-bottom:70px}
    .card{background:var(--card); border:1px solid var(--border); border-radius:16px; padding:12px; display:flex; gap:12px; align-items:center; cursor:pointer; transition:transform .05s ease, background .15s}
    .card:hover{background:#1a1e27}
    .card:active{transform:scale(.995)}
    .drag-handle{display:flex; align-items:center; padding:0 8px 0 4px; cursor:grab; color:var(--muted); opacity:0.1; touch-action:none}
    .drag-handle svg{width:24px; height:24px; pointer-events:none}
    .card.dragging {cursor:grabbing}
    .card.dragging .drag-handle{cursor:grabbing}
    .card.dragging{opacity:.85; box-shadow:0 12px 28px rgba(0,0,0,.4);}
    .placeholder{border:2px dashed rgba(255,255,255,.15); border-radius:16px; height:68px; margin:4px 0}
    .avatar{width:44px; height:44px; border-radius:14px; background:linear-gradient(145deg,#1f2430,#111319); display:grid; place-items:center; color:var(--muted); font-weight:700; overflow:hidden}
    .avatar img{width:100%; height:100%; object-fit:cover}
    .meta{flex:1}
    .meta .name{font-weight:700}
    .meta .sub{color:var(--muted); font-size:12px}
    .amount{font-weight:800}
    .amount.pos{color:var(--ok)}
    .amount.neg{color:var(--danger)}

    /* DETAIL */
    .detail{display:none; flex-direction:column; gap:12px; min-height:100%; align-items:center; text-align:center}
    .detail > *:not(.actions):not(.amountRow):not(.detailTop):not(.map-wrap){width:100%; max-width:280px; margin:0 auto}
    .detail > .detailTop{width:100%; padding:0 12px}
    .detail .actions, .detail .amountRow{width:100%; max-width:280px; margin:0 auto}
    .detail .map-wrap{width:100%; max-width:340px; margin:0 auto}
    .row{display:flex; gap:8px; justify-content:center}
    .detailTop{display:flex; align-items:center; justify-content:space-between; width:100%}
    input, textarea, select, button{ font:inherit; }
    input, textarea, select{ width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--border); background:#101219; color:var(--text); user-select:text; -webkit-user-select:text; -moz-user-select:text; -ms-user-select:text;}    
    textarea{min-height:92px; resize:vertical}
    .readonly input, .readonly textarea, .readonly select{opacity:.75; pointer-events:none}
    .readonly #dLocation{opacity:.5; pointer-events:none}
    .readonly #customAmount{opacity:1; pointer-events:auto}
    
    /* NOTES EXPANDABLE */
    .notesExpandable{border:1px solid var(--border); border-radius:12px; padding:12px; background:#0f1218; cursor:pointer; display:flex; flex-direction:column; align-items:flex-start; user-select:none; text-align:left; color:var(--muted); max-height:100px; overflow:hidden; transition:max-height .3s ease, background .2s ease}
    .notesExpandable:hover{background:#151821}
    .notesExpandable.expanded{background:linear-gradient(145deg,#1a1e27,#131820); color:var(--text); max-height:none; overflow:visible}
    .notesContent{margin:0; font-family:inherit; white-space:pre-wrap; word-wrap:break-word; font-size:14px; color:inherit; line-height:1.5; display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; overflow:hidden; text-overflow:ellipsis; width:100%}
    .notesContent.show{display:block; -webkit-line-clamp:unset; overflow:visible; text-overflow:unset}

    /* HIDE number spinners */
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0 }
    input[type=number]{ -moz-appearance:textfield }

    /* ACTION BUTTONS */
    .actions{display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-top:4px}
    .btn{display:inline-flex; align-items:center; justify-content:center; gap:8px; height:44px; background:#1a1e27; border:1px solid var(--border); color:#fff; padding:0 14px; border-radius:999px; cursor:pointer; transition:transform .08s ease, background .15s}
    .btn:hover{background:#1f2430}
    .btn:active{transform:scale(.98)}
    .btn.ghost{background:transparent; color:#fff}
    .btn.ok{background:var(--okbg); border-color:var(--okbor)}
    .btn.bad{background:var(--dangbg); border-color:var(--dangbor)}

    /* Equal width custom input */
    .amountRow #customAmount{ height:44px; border-radius:999px; border:1px solid var(--border); background:#1a1e27; color:var(--text); padding:0 14px; width:100%; }
    .amountRow{margin-top:4px}

    .muted{color:var(--muted)}
    .center-avatar{display:flex; justify-content:center; margin-top:8px}
    .avatar.big{width:80px; height:80px; border-radius:22px; border:2px solid rgba(255,255,255,.12); background:linear-gradient(145deg,#1f2430,#111319); box-shadow:0 10px 18px rgba(0,0,0,.28)}

    .balanceWrap{display:flex; align-items:center; gap:8px; padding:8px 10px; border-radius:12px}
    .balanceWrap.highlight{background:var(--goodbg); outline:1px solid rgba(34,197,94,.3)}
    .badge{padding:4px 8px; border-radius:999px; font-size:12px; border:1px solid rgba(255,255,255,.12);}

    /* MAP */
    .map-wrap{position:relative}
    .map{border:0; width:100%; height:340px; border-radius:14px; border:1px solid var(--border); pointer-events:auto}

    /* FOOTER */
    .copyright{margin-top:12px; text-align:center; color:var(--muted); font-size:12px; padding-bottom:12px}

    /* FAB */
    .fab{position:sticky; bottom:0; left:0; right:0; width:100%; height:56px; border-radius:0 0 12px 12px; display:grid; place-items:center; cursor:pointer; background:linear-gradient(145deg,#1a2847,#0f1626); color:var(--text); font-weight:900; border:1px solid var(--border); box-shadow:0 -4px 12px rgba(0,0,0,.3); z-index:5; transition:background .3s ease; margin:0; border-top:1px solid var(--border)}
    .fab:hover{filter:brightness(1.05)}
    .fab:active{transform:scale(.98)}
    .fab.dark{background:linear-gradient(145deg,#1a2847,#0f1626); color:var(--text); border-top-color:rgba(255,255,255,.15)}

    /* MODAL */
    .dialog-wrap{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.5); z-index:30; padding:20px}
    .dialog{width:520px; max-width:92vw; background:#0f1218; border:1px solid var(--border); border-radius:18px; padding:12px; box-shadow:var(--shadow); max-height:85vh; overflow:auto}
    .dialog h3{margin:10px 0 8px}
    .dialog .row{margin:6px 0}
    .priceRow{display:flex; align-items:center; gap:10px}
    .priceRow .price{width:110px}
    .priceRow .label{font-size:14px; color:var(--muted)}
    .divider{display:flex; align-items:center; gap:10px; margin:10px 0 6px;}
    .divider::before, .divider::after{content:''; height:1px; background:var(--border); flex:1}
    .divider span{font-size:12px; color:var(--muted); letter-spacing:.4px}
    .footer{display:flex; justify-content:center; align-items:center; gap:10px; margin-top:14px; flex-wrap:wrap}
    .footerRight{display:flex; gap:10px}
    .btn.danger{background:linear-gradient(145deg,#ef4444,#dc2626); border-color:transparent; color:#fff; font-weight:700}
    .btn.primary{background:linear-gradient(145deg,#1a2847,#0f1626); border-color:transparent; color:var(--text); font-weight:900}

    /* Upload (avatar) */
    .upload{display:flex; align-items:center; gap:12px; border:1px dashed var(--border); border-radius:16px; padding:12px; background:#0f1218; cursor:pointer}
    .upload:hover{background:#121622}
    .upload .hint{font-size:12px; color:var(--muted)}
    .upload .sp{flex:1}
    .mini{height:36px; padding:0 12px; border-radius:999px; border:1px solid transparent; cursor:pointer}

    /* Install bar */
    .installbar{position:fixed; left:50%; transform:translateX(-50%); bottom:14px; width:min(560px,92vw); background:#0f1218; border:1px solid var(--border); border-radius:14px; padding:10px 12px; box-shadow:var(--shadow); display:none; align-items:center; gap:10px; z-index:1000}
    .installbar .label{flex:1; font-size:14px}
    .installbar .close{width:32px; height:32px; border-radius:10px; display:grid; place-items:center; border:1px solid var(--border); cursor:pointer}
    .installbar .action{height:36px; padding:0 12px; border-radius:999px; background:linear-gradient(145deg,#1a2847,#0f1626); color:var(--text); border:none; font-weight:800; cursor:pointer}

    /* Income Type Selector */
    .incomeTypeSelector{display:flex; gap:10px; margin:10px 0; justify-content:center}
    .incomeTypeBtn{flex:1; height:48px; border-radius:14px; border:1px solid var(--border); background:#1a1e27; color:var(--muted); cursor:pointer; transition:all .15s ease; font-weight:600; font-size:14px}
    .incomeTypeBtn:hover{background:#1f2430}
    .incomeTypeBtn.active{background:linear-gradient(145deg,#1a2847,#0f1626); border:none; color:var(--text); font-weight:700}
    
    /* Month Selector */
    .monthBtn{padding:12px 8px; border-radius:10px; border:1px solid var(--border); background:#1a1e27; color:var(--text); cursor:pointer; transition:all .15s ease; font-size:12px; font-weight:600; text-align:center}
    .monthBtn:hover{background:#1f2430}
    .monthBtn.active{background:linear-gradient(145deg,#1a2847,#0f1626); color:var(--accent); border-color:var(--accent)}
    .monthBtn.current{border-color:var(--accent-2); color:var(--accent-2)}

    /* Year Selector */
    .monthSelectorHeader{display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-bottom:1px solid var(--border)}
    .yearDisplay{font-weight:700; cursor:pointer; padding:6px 10px; border-radius:8px; border:1px solid var(--border); background:#1a1e27; transition:all .15s ease; user-select:none}
    .yearDisplay:hover{background:#1f2430}
    .yearSelectorWrap{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.5); z-index:40}
    .yearDropdown{width:120px; max-width:92vw; background:#0f1218; border:1px solid var(--border); border-radius:12px; padding:0; box-shadow:var(--shadow); max-height:60vh; overflow:auto; display:flex; flex-direction:column}
    .yearOption{padding:12px 16px; cursor:pointer; transition:background .15s ease; border:none; background:transparent; color:var(--text); text-align:left; font-weight:600}
    .yearOption:hover{background:#1a1e27}
    .yearOption.active{background:linear-gradient(145deg,#1a2847,#0f1626); color:var(--accent)}

    .goTodayBtn{width:100%; padding:10px 12px; background:#1a1e27; border:1px solid var(--border); color:var(--text); border-radius:10px; cursor:pointer; transition:all .15s ease; font-weight:600; font-size:13px}
    .goTodayBtn:hover{background:#1f2430}

    /* TERMINY VIEW */
    .weekContainer{display:flex; flex-direction:column; gap:0; margin-bottom:24px; padding:0 4px}
    .dayCard{display:grid; grid-template-columns:70px 1fr; gap:10px; align-items:flex-start; background:transparent; border:1px solid var(--border); padding:12px; border-radius:12px}
    .dayCard.today{border:1px solid var(--accent); background:rgba(93,215,239,.12)}
    .dayCard.empty{opacity:1}
    .dayHeader{font-weight:700; font-size:13px; color:var(--accent); letter-spacing:.1px; white-space:nowrap}
    .dayHeader.today{color:var(--accent)}
    .lessonsList{display:flex; flex-direction:column; gap:6px}
    .lessonItem{background:transparent; border:none; border-radius:0; padding:0; font-size:11px; line-height:1.6; color:var(--muted); transition:all .15s ease; cursor:pointer; display:flex; flex-direction:column}
    .lessonItem:hover{background:transparent}
    .lessonItem > div:first-child{display:flex; align-items:center; gap:10px; margin-bottom:3px}
    .lessonTime{color:var(--text); font-weight:600; font-size:11px}
    .lessonTypeAndStudent{display:flex; align-items:center; gap:6px}
    .lessonType{display:inline-block; padding:1px 5px; border-radius:3px; font-size:9px; font-weight:700; flex-shrink:0}
    .lessonType.st{background:rgba(139,92,246,.25); color:#b085f5}
    .lessonType.zd{background:rgba(110,231,255,.25); color:#6ee7ff}
    .lessonStudent{color:var(--text); font-weight:600; font-size:11px}
    .lessonNote{color:var(--muted); font-size:10px; margin-top:2px; font-style:italic; word-wrap:break-word; word-break:break-word; white-space:pre-wrap; text-align:left}
    .emptyLessonMsg{color:var(--muted); font-size:11px}

    .terminyActions{display:grid; grid-template-columns:1fr; gap:10px; margin-bottom:16px; justify-items:center}
    .terminyBtn{background:#1a1e27; border:1px solid var(--border); color:var(--text); padding:12px; border-radius:12px; cursor:pointer; font-weight:600; font-size:13px; transition:all .15s ease}
    .terminyBtn:hover{background:#1f2430; border-color:var(--accent)}
    .terminyBtn:active{transform:scale(.98)}

    /* MONTHLY CALENDAR */
    .monthCalendarWrap{background:#151821; border:1px solid var(--border); border-radius:14px; padding:12px; margin-top:20px}
    .monthHeader{display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; gap:10px}
    .monthNavBtn{width:32px; height:32px; border-radius:8px; border:1px solid var(--border); background:#1a1e27; color:var(--text); cursor:pointer; font-size:18px; transition:all .15s ease; display:flex; align-items:center; justify-content:center}
    .monthNavBtn:hover{background:#1f2430; border-color:var(--accent)}
    .monthTitle{flex:1; text-align:center; font-weight:800; font-size:16px; color:var(--text); text-transform:capitalize}
    .weekDaysHeader{display:grid; grid-template-columns:repeat(7,1fr); gap:6px; margin-bottom:8px; text-align:center}
    .dayHeader{color:var(--muted); font-size:11px; font-weight:700; letter-spacing:.5px; padding:6px 0}
    .monthGrid{display:grid; grid-template-columns:repeat(7,1fr); gap:6px}
    .dayCell{background:#1a1e27; border:1px solid var(--border); border-radius:10px; padding:6px 4px; text-align:center; cursor:pointer; aspect-ratio:1; display:flex; flex-direction:column; position:relative; transition:all .15s ease; justify-content:space-between; min-width:0; overflow:hidden}
    .dayCell:hover{background:#1f2430; border-color:var(--accent)}
    .dayCell.otherMonth{opacity:.3; cursor:default}
    .dayCell.otherMonth:hover{background:#1a1e27; border-color:var(--border)}
    .dayCell.today{border:1px solid rgba(228, 228, 228, 0.918); background:#1f2430}
    .dayCell.hasChange::before{content:'‚öô'; position:absolute; top:1px; right:1px; font-weight:800; color:#fff; font-size:12px; text-shadow: 0 0 8px rgba(93,215,239,.6), 0 0 16px rgba(139,92,246,.4)}
    .dayCellNumber{font-weight:700; color:var(--text); font-size:13px; margin-bottom:2px}
    .dayCellNumber.weekend{color:#ef4444}
    .dayCellIndicators{display:grid; gap:1px; width:100%; position:relative; height:auto; place-items:center}
    
    /* Lesson bar - single bar with color segments */
    .lessonBar{width:100%; height:8px; border-radius:4px; background:var(--accent); background-size:100%; box-shadow: inset 0 0 4px rgba(0,0,0,.3)}
    .lessonMoreBadge{position:absolute; left:50%; top:50%; transform:translate(-50%, -50%); font-size:8px; color:#fff; font-weight:700; z-index:10; pointer-events:none}

    /* PLAN EDIT POPUPS */
    .planEditWrap{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.5); z-index:60; overflow-y:auto; padding:16px 12px}
    .planEditDialog{width:100%; max-width:680px; background:#0f1218; border:1px solid var(--border); border-radius:16px; padding:14px; box-shadow:var(--shadow); display:flex; flex-direction:column; gap:12px}
    #editPlanDaySelector{display:grid; grid-template-columns:1fr 1fr; gap:8px; max-height:56vh; overflow-y:auto; padding-right:2px}
    .planEditDialog h2{margin:0 0 8px 0; font-size:18px; color:var(--text)}
    .dayColumnGrid{display:grid; grid-template-columns:1fr; gap:8px; max-height:auto; overflow-y:auto}
    .dayColumn{background:#1a1e27; border:1px solid var(--border); border-radius:10px; padding:8px; display:flex; flex-direction:column; gap:6px}
    .dayColumn h3{margin:0 0 6px 0; font-size:13px; color:var(--accent); font-weight:700}
    .lessonRow{background:#0f1218; border:1px solid rgba(255,255,255,.08); border-radius:8px; padding:8px; display:grid; grid-template-columns:1fr; gap:5px; font-size:11px}
    .lessonRow input, .lessonRow select{font-size:11px; padding:6px 8px; height:auto}
    .lessonRowTime{display:grid; grid-template-columns:70px 1fr; gap:6px; align-items:center}
    .lessonRowTime input{font-size:10px}
    .durationButtonGroup{display:flex; gap:2px; flex-wrap:wrap}
    .durationBtn{padding:4px 6px; font-size:9px; font-weight:600; border:1px solid rgba(93,215,239,.4); border-radius:4px; background:transparent; color:var(--muted); cursor:pointer; transition:all .15s ease; white-space:nowrap}
    .durationBtn:hover{border-color:var(--accent); color:var(--accent)}
    .durationBtn.active{background:var(--accent); color:#fff; border-color:var(--accent)}
    .lessonRowTypeStudent{display:grid; grid-template-columns:70px 1fr; gap:4px; align-items:center}
    .typeButtonGroup{display:flex; gap:3px; border:1px solid var(--border); border-radius:6px; background:#0a0d12; padding:2px}
    .typeBtn{flex:1; padding:5px 8px; font-size:10px; font-weight:600; border:none; border-radius:4px; cursor:pointer; background:transparent; color:var(--muted); transition:all .15s ease}
    .typeBtn.st{background:transparent; color:var(--muted)}
    .typeBtn.st.active{background:var(--accent-2); color:#fff}
    .typeBtn.zd{background:transparent; color:var(--muted)}
    .typeBtn.zd.active{background:var(--accent); color:#fff}
    .lessonRowActions{display:grid; grid-template-columns:1fr; gap:4px; justify-items:center}
    .lessonRowActions button{font-size:10px; padding:6px 12px;width: 100px; height:28px; background:linear-gradient(135deg,#4a4a4a,#2d2d2d); border:none; color:#e5e5e5; font-weight:600; border-radius:6px; cursor:pointer; transition:all .15s ease}
    .lessonRowActions button:hover{filter:brightness(1.1)}
    .lessonRowActions button:active{transform:scale(.98)}
    .addLessonBtn{background:rgba(93,215,239,.15); border:1px dashed var(--accent); color:var(--accent); padding:6px; border-radius:8px; cursor:pointer; font-size:10px; font-weight:600; transition:all .15s ease; margin-top:2px}
    .addLessonBtn:hover{background:rgba(93,215,239,.25)}
    
    /* DAY SELECTOR BUTTONS */
    .editPlanDayButton{background:#1a1e27; border:1px solid var(--border); color:var(--text); padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:600; font-size:12px; transition:all .15s ease; text-align:center}
    .editPlanDayButton:hover{background:#1f2430; border-color:var(--accent)}
    .editPlanDayButton:active{transform:scale(.98)}
    .editPlanDayButton.today{background:rgba(93,215,239,.12); border:1px solid var(--accent); color:var(--accent)}
    .editPlanDayButton:last-child{grid-column:1/-1}
    .planEditFooter{display:flex; gap:8px; justify-content:center; flex-wrap:wrap}
    .planEditFooter button{padding:8px 14px; border-radius:8px; border:none; cursor:pointer; font-weight:600; font-size:12px; transition:all .15s ease}
    .planEditFooter .btn{background:#1a1e27; border:1px solid var(--border); color:var(--text)}
    .planEditFooter .btn:hover{background:#1f2430}
    .planEditFooter .btn.primary{background:linear-gradient(145deg,#1a2847,#0f1626); color:var(--text); border:none}
    .planEditFooter .btn.ghost{background:transparent; color:var(--text); border:1px solid var(--border)}

    /* CALENDAR STYLES */
    .calendarHeader{display:flex; align-items:center; justify-content:space-between; margin-bottom:12px}
    .calendarNav{width:32px; height:32px; border-radius:8px; border:1px solid var(--border); background:#1a1e27; color:var(--text); cursor:pointer; font-size:18px; font-weight:300; transition:all .15s ease; display:grid; place-items:center; padding:0}
    .calendarNav:hover{background:#1f2430; border-color:var(--accent)}
    .calendarNav:active{transform:scale(.95)}
    .calendarMonthYear{font-weight:700; font-size:14px; color:var(--text); text-align:center; letter-spacing:.3px; min-width:120px}
    .calendarWeekDays{display:grid; grid-template-columns:repeat(7,1fr); gap:4px; margin-bottom:8px; text-align:center}
    .calendarWeekDays div{font-size:11px; font-weight:600; color:var(--muted); padding:4px 0}
    .miniCalendar{display:grid; grid-template-columns:repeat(7,1fr); gap:4px}
    .miniCalendar button{padding:8px 4px; border-radius:6px; border:1px solid var(--border); background:#1a1e27; color:var(--muted); cursor:pointer; font-size:11px; font-weight:600; transition:all .15s ease; min-height:40px; width:100%; display:flex; align-items:center; justify-content:center}
    .miniCalendar button:hover{background:#1f2430; border-color:var(--accent)}
    .miniCalendar button:active{transform:scale(.95)}
    .miniCalendar button.other-month{opacity:0.25; pointer-events:none}
    .miniCalendar button.today{border:1px solid var(--accent); color:var(--accent); font-weight:700; background:rgba(93,215,239,.12)}
    .miniCalendar button.selected{background:linear-gradient(145deg,rgba(93,215,239,.25),rgba(93,215,239,.15)); border-color:var(--accent); color:var(--accent); font-weight:700}

    /* SETTINGS MODAL */
    .settings-dialog-wrap{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.5); z-index:50}
    .settings-dialog{width:520px; max-width:92vw; background:#0f1218; border:1px solid var(--border); border-radius:18px; padding:20px; box-shadow:var(--shadow); max-height:90vh; overflow:auto}
    .settings-dialog h2{margin:0 0 16px 0; font-size:20px; color:var(--text)}
    .settings-section{margin-bottom:16px}
    .settings-section-title{font-size:13px; font-weight:700; color:var(--muted); text-transform:uppercase; letter-spacing:.5px; margin-bottom:10px; display:block}
    .settings-btn-group{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .settings-btn-group .btn{width:100%; display:flex; align-items:center; justify-content:center; gap:8px}

    /* STATS VIEW */
    .monthSelector{display:flex; align-items:center; justify-content:center; gap:16px; padding:12px 0; margin-bottom:12px}
    .monthNav{width:36px; height:36px; border-radius:10px; border:1px solid var(--border); background:#151821; color:var(--text); cursor:pointer; display:grid; place-items:center; transition:background .15s ease}
    .monthNav:hover{background:#1a1e27}
    .monthNav:active{transform:scale(.95)}
    .monthNav svg{width:18px; height:18px; fill:currentColor}
    .monthDisplay{font-weight:700; font-size:14px; color:var(--text); min-width:100px; text-align:center; letter-spacing:.3px; cursor:pointer; padding:6px 10px; border-radius:10px; transition:background .15s ease; user-select:none}
    .monthDisplay:hover{background:rgba(255,255,255,0.06)}

    /* Summary Grid */
    .summaryGrid{display:grid; grid-template-columns:repeat(2,1fr); gap:10px; margin-bottom:16px}
    .summaryCard{background:linear-gradient(135deg,rgba(139,92,246,.15),rgba(110,231,255,.1)); border:1px solid var(--border); border-radius:14px; padding:14px 12px; text-align:center}
    .summaryCard:first-child{grid-column:1 / -1; width:100%}
    .summaryLabel{font-size:12px; color:var(--muted); font-weight:500; margin-bottom:6px; letter-spacing:.3px}
    .summaryAmount{font-weight:800; font-size:16px; color:var(--accent); letter-spacing:-.4px}
    .statBar{height:3px; background:var(--border); border-radius:2px; margin-top:8px; overflow:hidden}
    .statBarFill{height:100%; background:linear-gradient(90deg, var(--accent-2), var(--accent)); border-radius:2px; transition:width .3s ease}
    
    /* Chart */
    .chartWrapper{background:#0a0d13; border:1px solid var(--border); border-radius:14px; padding:20px 12px; margin-bottom:16px; min-height:160px; display:flex; align-items:center; justify-content:center}
    .chartWrapper canvas{width:100% !important; height:auto !important; max-height:180px}
    
    /* Separator */
    .statsSection{margin-top:4px}
    .statsHeader{display:flex; align-items:center; gap:10px; margin:6px 0; color:var(--text); font-weight:700; font-size:13px; letter-spacing:.2px; white-space:nowrap}
    .statsHeader::before, .statsHeader::after{content:''; height:1px; background:var(--border); flex:1}
    .statsHeader span{flex:0}

    /* Empty State */
    .emptyState{border:1px solid var(--border); border-radius:16px; padding:24px; background:#0f1218; cursor:default; display:flex; justify-content:center; align-items:center; text-align:center; color:var(--muted); font-size:14px; pointer-events:none; user-select:none; line-height:1.6}

    /* Student Count */
    .studentCount{text-align:center; color:var(--muted); font-size:13px; padding:8px 0 12px 0; margin-bottom:4px; font-weight:500}
    
    /* Annual Summary Section */
    .annualSummaryWrap{margin-bottom:16px}
    .annualSummaryHeader{display:flex; align-items:center; gap:10px; margin-bottom:12px; color:var(--text); font-weight:700; font-size:13px; letter-spacing:.2px; white-space:nowrap}
    .annualSummaryHeader::before, .annualSummaryHeader::after{content:''; height:1px; background:var(--border); flex:1}
    .annualSummaryHeader span{flex:0}
    .annualSummaryGrid{display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-bottom:16px}
    .annualCard{background:linear-gradient(135deg,rgba(110,231,255,.12),rgba(139,92,246,.12)); border:1px solid var(--border); border-radius:14px; padding:12px; text-align:center}
    .annualCard .summaryLabel{font-size:11px; color:var(--muted); font-weight:500; margin-bottom:6px; letter-spacing:.3px}
    .annualCard .summaryAmount{font-weight:800; font-size:14px; color:var(--accent); letter-spacing:-.4px}

    @media (max-width:600px){
      .weekContainer{gap:6px; padding:0 2px}
      .dayCard{grid-template-columns:65px 1fr; gap:8px; padding:10px}
      .dayHeader{font-size:12px; padding:2px 0}
      .lessonItem{font-size:10px; padding:6px 8px}
      .footer{gap:6px}
      .btn{height:40px; padding:0 12px; font-size:13px; flex:1}
      .btn.primary, .btn.ghost, .btn.danger{flex:1; min-width:0}
    }
    @media (max-width:440px){ .phone{width:100%; height:calc(100vh - 48px)} }
    
    /* --- Display-Mode (installed PWA) --- */
    @media (display-mode: standalone), (display-mode: fullscreen) {
      body{ padding:0; }
      .phone{ width:100vw; height:100dvh; border-radius:0; padding:0; border:0; box-shadow:none; }
      .notch{ display:none; }
      .screen{ border:0; border-radius:0; padding: calc(12px + env(safe-area-inset-top)) 12px calc(16px + env(safe-area-inset-bottom)) 12px; }
    }

    /* --- Mobile fullscreen mode (hide mockup chrome, respect notches) --- */
    @media (max-width: 600px), (pointer: coarse) {
      .phone{ width:100vw; height:100dvh; border-radius:0; padding:0; border:0; box-shadow:none; }
      .notch{ display:none; }
      .screen{ border:0; border-radius:0; padding: calc(12px + env(safe-area-inset-top)) 12px calc(16px + env(safe-area-inset-bottom)) 12px; }
      .fab{ right: calc(16px + env(safe-area-inset-right)); bottom: calc(16px + env(safe-area-inset-bottom)); }
      .copyright{ padding-bottom: calc(6px + env(safe-area-inset-bottom)); }
      .map{ height: 280px; }
      /* Dialog fullscreen with internal scroll so content is always reachable */
      .dialog-wrap{ align-items:stretch; justify-content:stretch; }
      .dialog{ width:100vw; max-width:100vw; height:100dvh; max-height:100dvh; border-radius:0; overflow:auto; }
      .dialog .footer{ position:sticky; bottom:0; background:#0f1218; padding-top:8px; padding-bottom: calc(10px + env(safe-area-inset-bottom)); border-top:1px solid var(--border); }
    }
  </style>
</head>
<body>

  <!-- SPLASH SCREEN -->
  <div class="splash" id="splash">
    <div class="splash-logo">Tuttorly</div>
  </div>

  <div class="phone" id="phone">
    <div class="notch"></div>
    <div class="screen">
      <div class="appbar">
                <div class="appbar-left">
          <div class="iconbtn ghost" id="supportBtn" title="Wesprzyj projekt">
            <svg viewBox="0 0 24 24"><path d="M7.5 16L3 12l4.5-4 1 1L5.5 12l3 3-1 1zm9-8l4.5 4-4.5 4-1-1 3-3-3-3 1-1zM14.2 4l-3 16h-1.4l3-16h1.4z" fill="currentColor"/></svg>
          </div>
        </div>

        <div class="appbar-center">
          <div class="title">Tuttorly</div>
        </div>
        <div class="appbar-right">
          <div class="iconbtn ghost" id="settingsBtn" title="Ustawienia">
            <svg viewBox="0 0 24 24"><path d="M19.14,12.94a7.43,7.43,0,0,0,.05-.94,7.43,7.43,0,0,0-.05-.94l2.11-1.65a.5.5,0,0,0,.12-.64l-2-3.46a.5.5,0,0,0-.6-.22l-2.49,1a7.26,7.26,0,0,0-1.63-.94l-.38-2.65A.5.5,0,0,0,13.72,1H10.28a.5.5,0,0,0-.49.41L9.41,4.06a7.26,7.26,0,0,0-1.63.94l-2.49-1a.5.5,0,0,0-.6.22l-2,3.46a.5.5,0,0,0,.12.64L3.86,11.06a7.43,7.43,0,0,0-.05.94,7.43,7.43,0,0,0,.05.94L1.75,14.59a.5.5,0,0,0-.12.64l2,3.46a.5.5,0,0,0,.6.22l2.49-1a7.26,7.26,0,0,0,1.63.94l.38,2.65a.5.5,0,0,0,.49.41h3.44a.5.5,0,0,0,.49-.41l.38-2.65a7.26,7.26,0,0,0,1.63-.94l2.49,1a.5.5,0,0,0,.6-.22l2-3.46a.5.5,0,0,0-.12-.64ZM12,15.5A3.5,3.5,0,1,1,15.5,12,3.5,3.5,0,0,1,12,15.5Z" fill="currentColor"/></svg>
          </div>
        </div>
        <input id="importFile" type="file" accept="application/json" style="display:none" />
      </div>

      <!-- NAVIGATION TABS -->
      <div class="tabs">
        <div class="tab" id="terminyTab" data-view="terminy">Terminy</div>
        <div class="tab active" id="studentsTab" data-view="students">Uczniowie</div>
        <div class="tab" id="statsTab" data-view="stats">Statystyki</div>
      </div>

      <!-- CALENDAR VIEW -->
      <div class="view" id="terminyView">
        <!-- Week Schedule -->
        <h3 style="color:#fff; margin:12px 0 16px; letter-spacing:.3px; font-size:17px; text-align:center; background:linear-gradient(145deg, rgba(139,92,246,.15), rgba(110,231,255,.12)); padding:12px 20px; border-radius:14px; display:inline-block; width:100%; border:1px solid rgba(139,92,246,.2)">Plan Tego Tygodnia</h3>
        <div class="weekContainer" id="weekContainer"></div>
        
        <!-- Action Buttons -->
        <div class="terminyActions">
          <button class="terminyBtn" id="editStaticPlanBtn">üìã Edytuj plan sta≈Çy</button>
          <button class="terminyBtn" id="addTempChangeBtn" style="display:none">‚ûï Dodaj zmianƒô</button>
        </div>

        <!-- Monthly Calendar -->
        <div class="monthCalendarWrap">
          <div class="monthHeader">
            <button class="monthNavBtn" id="prevMonthCal">‚Äπ</button>
            <div class="monthTitle" id="monthTitleCal">2025 Pa≈∫</div>
            <button class="monthNavBtn" id="nextMonthCal">‚Ä∫</button>
          </div>
          <div class="weekDaysHeader">
            <div class="dayHeader">PON.</div>
            <div class="dayHeader">WT.</div>
            <div class="dayHeader">≈öR.</div>
            <div class="dayHeader">CZW.</div>
            <div class="dayHeader">PT.</div>
            <div class="dayHeader">SOB.</div>
            <div class="dayHeader">NIEDZ.</div>
          </div>
          <div class="monthGrid" id="monthGrid"></div>
        </div>
      </div>

      <!-- STUDENTS VIEW -->
      <div class="view active" id="studentsView">
        <div class="list" id="listView"></div>
      </div>

      <!-- STATS VIEW -->
      <div class="view" id="statsView">
        <!-- Month Selector -->
        <div class="monthSelector">
          <button class="monthNav" id="prevMonth" title="Poprzedni miesiƒÖc">
            <svg viewBox="0 0 24 24"><path d="M15.41 7.41 14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
          </button>
          <div class="monthDisplay" id="monthDisplay">pa≈∫dziernik 2025</div>
          <button class="monthNav" id="nextMonth" title="Nastƒôpny miesiƒÖc">
            <svg viewBox="0 0 24 24"><path d="M10 6 8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
          </button>
        </div>

        <!-- Summary Cards -->
        <div class="summaryGrid">
          <div class="summaryCard">
            <div class="summaryLabel">Razem</div>
            <div class="summaryAmount" id="totalAmount">0 z≈Ç</div>
          </div>
          <div class="summaryCard">
            <div class="summaryLabel">üåê Karta</div>
            <div class="summaryAmount" id="onlineAmount">0 z≈Ç</div>
            <div class="statBar"><div class="statBarFill" id="onlineBar"></div></div>
          </div>
          <div class="summaryCard">
            <div class="summaryLabel">üíµ Got√≥wka</div>
            <div class="summaryAmount" id="cashAmount">0 z≈Ç</div>
            <div class="statBar"><div class="statBarFill" id="cashBar"></div></div>
          </div>
        </div>

        <!-- Annual Summary Section -->
        <div class="annualSummaryWrap">
          <div class="annualSummaryHeader">
            <span>Podsumowanie roczne</span>
          </div>
          <div class="annualSummaryGrid">
            <div class="annualCard">
              <div class="summaryLabel">Razem</div>
              <div class="summaryAmount" id="annualTotal">0 z≈Ç</div>
            </div>
            <div class="annualCard">
              <div class="summaryLabel">üåê Karta</div>
              <div class="summaryAmount" id="annualOnline">0 z≈Ç</div>
            </div>
            <div class="annualCard">
              <div class="summaryLabel">üíµ Got√≥wka</div>
              <div class="summaryAmount" id="annualCash">0 z≈Ç</div>
            </div>
          </div>
        </div>

        <!-- Earnings Chart -->

        <div class="chartWrapper">
          <canvas id="earningsChart"></canvas>
        </div>

        <!-- Separator with header -->
        <div class="statsSection">
          <div class="statsHeader">
            <span>Historia wp≈Çat</span>
          </div>
        </div>

        <!-- Earnings List -->
        <div class="list" id="earningsList"></div>
      </div>

      <!-- DETAIL VIEW -->
      <div class="detail readonly" id="detailView">
        <!-- top row with actions -->
        <div class="detailTop">
          <div class="iconbtn primary" id="inlineBack" title="Wr√≥ƒá">
            <svg viewBox="0 0 24 24"><path d="M15.41 7.41 14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
          </div>
          <div style="flex:1"></div>
          <div class="iconbtn primary" id="editBtn" title="Edytuj ucznia">
            <svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1.003 1.003 0 0 0 0-1.42l-2.34-2.34a1.003 1.003 0 0 0-1.42 0l-1.83 1.83 3.75 3.75 1.84-1.82z"/></svg>
          </div>
        </div>

        <!-- Avatar -->
        <div class="center-avatar"><div class="avatar big" id="dAvatar"></div></div>

        <!-- Name -->
        <div class="row"><input id="dName" placeholder="Imiƒô i nazwisko" style="max-width:280px; text-align:center" /></div>

        <!-- Subject/Class (previously place) - HIDDEN in view mode -->
        <div class="row" style="display:none"><input id="dPlace" placeholder="Przedmiot, klasa" style="max-width:280px; text-align:center" /></div>

        <!-- Expandable Notes -->
        <div class="notesExpandable" id="notesToggle" style="max-width:280px; display:none">
          <pre class="notesContent" id="dNotesDisplay"></pre>
        </div>
        <textarea id="dNotes" placeholder="Notatki o uczniu" style="display:none"></textarea>

        <!-- Balance -->
        <div id="balanceWrap" class="balanceWrap" style="max-width:280px; margin:0 auto; flex-direction:column; justify-content:center">
          <div style="color:var(--muted); font-size:14px; margin-bottom:4px">Nadwy≈ºka:</div>
          <span id="dBalance" class="amount" style="font-size:18px; font-weight:900">0 z≈Ç</span>
          <span id="freeBadge" class="badge" style="display:none; margin-left:0; margin-top:8px">Darmowa lekcja</span>
        </div>

        <!-- Active & Price -->
        <div class="row" id="activeRowView" style="gap:16px; max-width:280px">
          <div class="badge" id="activeBadge" style="flex:1">Aktywne: ‚Äî</div>
          <div class="badge" id="priceBadge" style="flex:1">Cena: ‚Äî</div>
        </div>

        <!-- Action Buttons -->
        <div class="actions" style="max-width:280px">
          <button class="btn ok" id="plus10">+10 z≈Ç</button>
          <button class="btn bad" id="minus10">‚àí10 z≈Ç</button>
          <button class="btn ghost" id="resetBtn" title="Wyzeruj saldo">Wyzeruj</button>
        </div>

        <!-- Amount Buttons -->
        <div class="actions amountRow" style="max-width:280px">
          <button class="btn ok padfix" id="addPlus">+ kwota</button>
          <button class="btn bad padfix" id="addMinus">‚àí kwota</button>
          <input id="customAmount" type="number" placeholder="Custom" />
        </div>

        <!-- Location -->
        <div class="row" style="max-width:280px"><input id="dLocation" placeholder="Miejsce (miasto)" style="text-align:center" /></div>

        <!-- Map Button -->
        <div class="row" style="margin-top: 12px; max-width:280px">
          <button class="btn" id="toggleMapBtn" style="width:100%">Poka≈º mapƒô</button>
        </div>
        <div class="map-wrap" style="display: none;"><iframe class="map" id="map" loading="lazy" referrerpolicy="no-referrer-when-downgrade" allowfullscreen></iframe></div>
      </div>

      <button class="fab" id="addBtn" title="Dodaj ucznia">+</button>
    </div>
  </div>

  <!-- DIALOG -->
  <div class="dialog-wrap" id="dialogWrap">
    <div class="dialog">
      <h3 id="dialogTitle">Nowy ucze≈Ñ</h3>
      <div class="row"><input id="sName" placeholder="Imiƒô i nazwisko" /></div>
      <div class="row"><input id="sPlace" placeholder="Miejsce (miasto, ulica)" /></div>
      <div class="row"><textarea id="sNotes" placeholder="Notatki"></textarea></div>

      <h3 style="margin-top:8px">Media</h3>
      <div class="row">
        <div id="avatarUpload" class="upload">
          <div id="avatarPreview" class="avatar big"></div>
          <div class="sp">
            <div class="name">Avatar (opcjonalnie)</div>
            <div id="avatarHint" class="hint">PNG/JPG ‚Äî kliknij, aby wybraƒá</div>
          </div>
          <button type="button" id="avatarPick" class="mini btn primary">Wybierz</button>
        </div>
        <input type="file" id="sAvatar" accept="image/*" style="display:none" />
        <b id="avatarInfo" style="display:none">(opcjonalnie)</b>
      </div>

      <h3 style="margin-top:8px">Cennik (PLN)</h3>
      <div class="divider"><span>ZDALNE</span></div>
      <div class="priceRow"><input class="price" id="priceR60" type="number" placeholder="np. 60" /><span class="label">‚Äî 60 min ZDALNE</span></div>
      <div class="priceRow"><input class="price" id="priceR90" type="number" placeholder="np. 90" /><span class="label">‚Äî 90 min ZDALNE</span></div>
      <div class="priceRow"><input class="price" id="priceR120" type="number" placeholder="np. 120" /><span class="label">‚Äî 120 min ZDALNE</span></div>

      <div class="divider"><span>STACJONARNE</span></div>
      <div class="priceRow"><input class="price" id="priceS60" type="number" placeholder="np. 70" /><span class="label">‚Äî 60 min STACJONARNE</span></div>
      <div class="priceRow"><input class="price" id="priceS90" type="number" placeholder="np. 100" /><span class="label">‚Äî 90 min STACJONARNE</span></div>
      <div class="priceRow"><input class="price" id="priceS120" type="number" placeholder="np. 140" /><span class="label">‚Äî 120 min STACJONARNE</span></div>

      <h3 style="margin-top:8px">Aktywne zajƒôcia (domy≈õlne)</h3>
      <div class="row">
        <select id="activeType">
          <option value="remote">Zdalne</option>
          <option value="station">Stacjonarne</option>
        </select>
        <select id="activeDur">
          <option value="60">60 min</option>
          <option value="90">90 min</option>
          <option value="120">120 min</option>
        </select>
      </div>

      <div class="footer">
        <button class="btn danger" id="deleteBtn" style="display:none">Usu≈Ñ ucznia</button>
        <div class="footerRight">
          <button class="btn ghost" id="cancelDialog">Anuluj</button>
          <button class="btn primary" id="confirmDialog">Zapisz</button>
        </div>
      </div>
    </div>
  </div>

  <!-- CONFIRM DELETE MODAL -->
  <div class="dialog-wrap" id="confirmWrap" style="display:none">
    <div class="dialog">
      <h3>UsunƒÖƒá ucznia?</h3>
      <p id="confirmText" class="muted">Tej operacji nie mo≈ºna cofnƒÖƒá.</p>
      <div class="footer">
        <div></div>
        <div class="footerRight">
          <button class="btn ghost" id="confirmCancel">Anuluj</button>
          <button class="btn danger" id="confirmDelete">Usu≈Ñ</button>
        </div>
      </div>
    </div>
  </div>

  <!-- INCOME ENTRY MODAL -->
  <div class="dialog-wrap" id="incomeDialogWrap">
    <div class="dialog" style="display:flex; flex-direction:column">
      <h3 id="incomeDialogTitle">Nowy wpis dochod√≥w</h3>
      
      <div class="row"><input id="incomeAmount" type="number" placeholder="Kwota (PLN)" step="0.01" inputmode="decimal" /></div>
      
      <div class="incomeTypeSelector">
        <button type="button" class="incomeTypeBtn active" data-type="cash">üíµ Got√≥wka</button>
        <button type="button" class="incomeTypeBtn" data-type="online">üåê Online</button>
      </div>
      <input id="incomeType" type="hidden" value="cash" />
      
      <div class="row"><input id="incomeDate" type="date" /></div>
      <div class="row"><textarea id="incomeDesc" placeholder="Opis (opcjonalnie)"></textarea></div>
      
      <div class="footer" style="margin-top:auto">
        <button class="btn danger" id="incomeDeleteBtn" style="display:none">Usu≈Ñ</button>
        <div class="footerRight">
          <button class="btn ghost" id="incomeCancelBtn">Anuluj</button>
          <button class="btn primary" id="incomeConfirmBtn">Zapisz</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MONTH SELECTOR MODAL -->
  <div class="dialog-wrap" id="monthSelectorWrap" style="display:none">
    <div class="dialog" style="padding:0; max-width:320px; display:flex; flex-direction:column">
      <div class="monthSelectorHeader">
        <div style="font-weight:700">Wybierz miesiƒÖc</div>
        <div class="yearDisplay" id="yearDisplay" onclick="openYearSelector()">2025</div>
      </div>
      <div id="monthSelectorGrid" style="padding:12px; display:grid; grid-template-columns:repeat(3,1fr); gap:8px; max-height:300px; overflow:auto; flex:1"></div>
      <div style="padding:12px; border-top:1px solid var(--border)">
        <button class="goTodayBtn" onclick="goToToday()">üìÖ Kliknij tutaj aby powr√≥ciƒá do dzisiaj</button>
      </div>
    </div>
  </div>

  <!-- YEAR SELECTOR MODAL -->
  <div class="yearSelectorWrap" id="yearSelectorWrap">
    <div class="yearDropdown" id="yearDropdown"></div>
  </div>
  <!-- SUPPORT MODAL -->
<div class="settings-dialog-wrap" id="supportDialogWrap">
  <div class="settings-dialog">
    <h2>Wsparcie projektu Tuttorly</h2>
    <p style="color:var(--muted); margin:16px 0; line-height:1.6">
      Tuttorly jest tworzony hobbystycznie i rozwijany w wolnym czasie. 
      Je≈õli chcesz wesprzeƒá pracƒô nad aplikacjƒÖ ‚Äì mo≈ºesz zrobiƒá to poprzez bezpo≈õrednie wsparcie finansowe lub aktywno≈õƒá w repozytorium.
    </p>

    <div class="settings-section">
      <span class="settings-section-title">Formy wsparcia</span>
      <div style="display:flex; flex-direction:column; gap:12px; margin-top:12px">

        <a href="https://paypal.me/" target="_blank" style="text-decoration:none">
          <div style="padding:12px; background:#1a1e27; border-radius:8px; border-left:3px solid var(--accent)">
            <strong style="color: white;">PayPal</strong>
            <p style="color:var(--muted); font-size:12px; margin:8px 0 0">
              Jednorazowe wsparcie przez PayPal.
            </p>
          </div>
        </a>

        <a href="https://tutaj.link.do.bleeka" target="_blank" style="text-decoration:none">
          <div style="padding:12px; background:#1a1e27; border-radius:8px; border-left:3px solid var(--accent-2)">
            <strong style="color: white;">BLIK (przelew)</strong>
            <p style="color:var(--muted); font-size:12px; margin:8px 0 0">
              Wsparcie szybkim przelewem BLIK.
            </p>
          </div>
        </a>

        <a href="https://github.com" target="_blank" style="text-decoration:none">
          <div style="padding:12px; background:#1a1e27; border-radius:8px; border-left:3px solid var(--ok)">
            <strong style="color: white;">GitHub</strong>
            <p style="color:var(--muted); font-size:12px; margin:8px 0 0">
              Zostaw gwiazdkƒô lub zg≈Çaszaj propozycje zmian.
            </p>
          </div>
        </a>

      </div>
    </div>

    <button class="btn primary" id="supportCloseBtn" style="width:100%; margin-top:16px">Zamknij</button>
  </div>
</div>


  <!-- SETTINGS MODAL -->
  <div class="settings-dialog-wrap" id="settingsDialogWrap">
    <div class="settings-dialog">
      <h2>‚öôÔ∏è Ustawienia</h2>
      
      <div class="settings-section">
        <span class="settings-section-title">ZarzƒÖdzanie danymi</span>
        <div class="settings-btn-group">
          <label class="btn primary" for="settingsImportFile" style="cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px">
            <svg viewBox="0 0 24 24" width="18" height="18"><path d="M19 12v7H5v-7H3v9h18v-9h-2zm-6 0 4-4-1.41-1.41L13 8.17V2h-2v6.17l-2.59-2.58L7 8l6 6z" fill="currentColor"/></svg>
            Importuj
          </label>
          <button class="btn primary" id="settingsExportBtn" style="display:flex; align-items:center; justify-content:center; gap:8px">
            <svg viewBox="0 0 24 24" width="18" height="18"><path d="M19 21H5v-7H3v9h18v-9h-2v7zM7 8l1.41 1.41L11 6.83V14h2V6.83l2.59 2.58L17 8l-5-5-5 5z" fill="currentColor"/></svg>
            Eksportuj
          </button>
          <input id="settingsImportFile" type="file" accept="application/json" style="display:none" />
        </div>
      </div>

      <div class="settings-section" style="border-top:1px solid var(--border); padding-top:16px; margin-top:16px">
        <span class="settings-section-title">Zamknij</span>
        <button class="btn ghost" id="settingsCloseBtn" style="width:100%">Anuluj</button>
      </div>
    </div>
  </div>

  <!-- INSTALL BAR -->
  <div id="installBar" class="installbar">
    <div class="logo" style="width:28px;height:28px">Tu</div>
    <div class="label" id="installText">Zainstaluj Tuttorly na ekranie g≈Ç√≥wnym.</div>
    <button id="installBtn" class="action">Zainstaluj</button>
    <div id="installClose" class="close">‚úï</div>
  </div>

  <!-- EDIT STATIC PLAN POPUP -->
  <div class="planEditWrap" id="editPlanWrap">
    <div class="planEditDialog">
      <h2>üìã Edytuj sta≈Çy plan zajƒôƒá</h2>
      
      <!-- Step 1: Day Selector -->
      <div id="editPlanStep1">
        <p style="color:var(--muted); margin:0 0 12px 0; font-size:13px">Krok 1: Wybierz dzie≈Ñ</p>
        <div id="editPlanDaySelector" style="display:grid; grid-template-columns:repeat(2,1fr); gap:10px; margin:12px 0"></div>
      </div>
      
      <!-- Step 2: Edit Lessons -->
      <div id="editPlanStep2" style="display:none">
        <p style="color:var(--muted); margin:0 0 12px 0; font-size:13px">Krok 2: Edytuj lekcje</p>
        <div class="dayColumnGrid" id="editPlanDayContainer"></div>
      </div>
      
      <div class="planEditFooter">
        <button class="btn ghost" id="editPlanCancel">Anuluj</button>
        <button class="btn ghost" id="editPlanBack" style="display:none">‚Üê Wr√≥ƒá</button>
        <button class="btn primary" id="editPlanSave" style="display:none">Zapisz</button>
      </div>
    </div>
  </div>

  <!-- ADD TEMP CHANGE POPUP -->
  <div class="planEditWrap" id="tempChangePlanWrap">
    <div class="planEditDialog">
      <h2>‚ûï Dodaj zmianƒô na dzie≈Ñ</h2>
      <div id="tempChangeStep1">
        <div class="calendarHeader">
          <button class="calendarNav" id="prevMonthBtn">‚Äπ</button>
          <div class="calendarMonthYear"><span id="calendarMonth"></span> <span id="calendarYear"></span></div>
          <button class="calendarNav" id="nextMonthBtn">‚Ä∫</button>
        </div>
        <div class="calendarWeekDays">
          <div>Pon</div><div>Wto</div><div>≈öro</div><div>Czw</div><div>PiƒÖ</div><div>Sob</div><div>Nie</div>
        </div>
        <div class="miniCalendar" id="miniCalendar"></div>
      </div>
      <div id="tempChangeStep2" style="display:none">
        <p style="color:var(--muted); margin:0 0 12px 0; font-size:13px">Krok 2: Edytuj plan dla wybranego dnia</p>
        <div class="dayColumnGrid" id="tempChangeDayContainer"></div>
      </div>
      <div class="planEditFooter">
        <button class="btn ghost" id="tempChangeCancelBtn" data-step1="Anuluj" data-step2="‚Üê Wr√≥ƒá">Anuluj</button>
        <button class="btn primary" id="tempChangeSaveBtn" style="display:none">Zapisz zmianƒô</button>
      </div>
    </div>
  </div>

  <script>
  const storeKey = 'tuttorly.v11';
  const el = id => document.getElementById(id);

  let state = load();
  let currentId = null;
  let currentView = 'students';
  let pendingDeleteId = null;
  let tempChangeFromDayPopup = false;

  // --- Safe History helpers (no-ops on sandbox/about:srcdoc) ---
  function canUseHistory(){
    try{ return !location.href.startsWith('about:') && !!history.pushState; }catch{ return false; }
  }
  function safePush(url, st){ if(!canUseHistory()) return; try{ history.pushState(st||{}, '', url||location.href); }catch{} }
  function safeReplace(url, st){ if(!canUseHistory()) return; try{ history.replaceState(st||{}, '', url||location.href); }catch{} }

  function uid(){ return Math.random().toString(36).slice(2,10); }
  function formatPLN(n){ try{ return new Intl.NumberFormat('pl-PL',{style:'currency',currency:'PLN', maximumFractionDigits:0}).format(n);}catch{ return Math.round(n)+' z≈Ç'; } }
  function save(){ localStorage.setItem(storeKey, JSON.stringify(state)); }
  function load(){ const raw = localStorage.getItem(storeKey); if(raw){ try{ const d=JSON.parse(raw); d.students?.forEach((s,i)=>{ if(typeof s.order!=="number") s.order=i; if(!s.pricing) s.pricing={}; }); if(!d.earnings) d.earnings=[]; return d; }catch{} }
    return { students:[
      {id:uid(), order:0, name:'Anna Nowak', place:'Zielona G√≥ra', notes:'Matematyka, 7 klasa', balance:10, pricing:{remote60:60, remote90:90, remote120:120, station60:80, station90:110, station120:140}, active:{type:'remote', dur:60}},
      {id:uid(), order:1, name:'Jan Kowalski', place:'Wroc≈Çaw', notes:'Fizyka, matura', balance:-10, pricing:{remote60:70, remote90:100, remote120:120, station60:90, station90:130, station120:160}, active:{type:'station', dur:90}}
    ], earnings:[] }; }

  window.addEventListener('load', ()=>{ setTimeout(()=>{ const s = el('splash'); if(s) s.style.display='none'; el('phone').classList.add('show'); }, 1200); });

  // View switching for tabs
  function switchTab(tabName){
    // Close detail view when switching tabs
    if(el('detailView') && el('detailView').style.display === 'flex'){
      setView('list');
      currentId = null;
    }

    // Update tab active state
    const tabs = document.querySelectorAll('.tabs .tab');
    tabs.forEach(tab => tab.classList.remove('active'));
    const activeTab = document.querySelector(`.tabs .tab[data-view="${tabName}"]`);
    if(activeTab) activeTab.classList.add('active');

    // Update view visibility
    const views = document.querySelectorAll('.view');
    views.forEach(view => view.classList.remove('active'));
    const activeView = el(tabName + 'View');
    if(activeView) activeView.classList.add('active');

    // Update FAB style and render view
    const fab = el('addBtn');
    if(tabName === 'stats'){
      if(fab) { fab.classList.add('dark'); fab.style.display='grid'; }
            // Initialize current month and year if not set
      const monthDisplay = el('monthDisplay');
     if(monthDisplay && monthDisplay.textContent.includes('pa≈∫dziernik 2025')){
        const today = new Date();
        const todayMonth = today.getMonth() + 1;
        const todayYear = today.getFullYear();
       const monthInv = {1:'stycze≈Ñ', 2:'luty', 3:'marzec', 4:'kwiecie≈Ñ', 5:'maj', 6:'czerwiec', 7:'lipiec', 8:'sierpie≈Ñ', 9:'wrzesie≈Ñ', 10:'pa≈∫dziernik', 11:'listopad', 12:'grudzie≈Ñ'};
        monthDisplay.textContent = monthInv[todayMonth] + ' ' + todayYear;
      }
      renderStats();
      renderEarnings();
    } else if(tabName === 'terminy'){
      if(fab) fab.style.display='none';
    } else {
      if(fab) { fab.classList.remove('dark'); fab.style.display='grid'; }
    }

    currentView = tabName;
  }

  // Tab click handlers
  el('terminyTab')?.addEventListener('click', ()=>{ switchTab('terminy'); });
  el('studentsTab')?.addEventListener('click', ()=>{ switchTab('students'); });
  el('statsTab')?.addEventListener('click', ()=>{ switchTab('stats'); });

  // ===== SWIPE NAVIGATION =====
  let touchStartX = 0, touchStartY = 0, touchStartTime = 0;
  const SWIPE_THRESHOLD = 50; // pixels
  const SWIPE_TIME_THRESHOLD = 300; // milliseconds

  function handleSwipe(direction){
    if(direction === 'left'){
      if(currentView === 'terminy') switchTab('students');
      else if(currentView === 'students') switchTab('stats');
    } else if(direction === 'right'){
      if(currentView === 'stats') switchTab('students');
      else if(currentView === 'students') switchTab('terminy');
    }
  }

  // Touch start
  document.addEventListener('touchstart', (e)=>{
    // Don't swipe if touching input/textarea or if modals are open
    if(e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
    if(e.target.closest('.drag-handle')) return; // Ignore drag-handle
    if(e.target.closest('button')) return; // Ignore buttons
    if(dialog && dialog.style.display === 'flex') return;
    if(el('incomeDialogWrap') && el('incomeDialogWrap').style.display === 'flex') return;
    if(el('monthSelectorWrap') && el('monthSelectorWrap').style.display === 'flex') return;
    if(el('yearSelectorWrap') && el('yearSelectorWrap').style.display === 'flex') return;

    touchStartX = e.touches[0].clientX;
    touchStartY = e.touches[0].clientY;
    touchStartTime = Date.now();
  }, false);

  // Touch end
  document.addEventListener('touchend', (e)=>{
    // Ignore if inputs are involved or if dragging is active
    if(e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
    if(dragEl) return; // Don't swipe if drag is active
    if(e.target.closest('.drag-handle')) return;
    if(e.target.closest('button')) return;

    const touchEndX = e.changedTouches[0].clientX;
    const touchEndY = e.changedTouches[0].clientY;
    const touchEndTime = Date.now();

    const deltaX = touchEndX - touchStartX;
    const deltaY = touchEndY - touchStartY;
    const deltaTime = touchEndTime - touchStartTime;

    // Ensure it's a horizontal swipe (not vertical scroll)
    if(Math.abs(deltaY) > Math.abs(deltaX)) return;
    if(deltaTime > SWIPE_TIME_THRESHOLD) return;
    if(Math.abs(deltaX) < SWIPE_THRESHOLD) return;

    // Determine swipe direction
    if(deltaX > 0){
      handleSwipe('right');
    } else {
      handleSwipe('left');
    }
  }, false);

  function setView(which){
    const list = el('listView');
    const detail = el('detailView');
    const fab = el('addBtn');
    const studentsView = el('studentsView');
    
    if(which==='detail'){
      studentsView && (studentsView.style.display='none');
      detail && (detail.style.display='flex');
      fab && (fab.style.display='none');
    } else {
      studentsView && (studentsView.style.display='flex');
      detail && (detail.style.display='none');
      fab && (fab.style.display='grid');
    }
  }

  document.addEventListener('click', (e)=>{
    const backBtn = e.target.closest ? e.target.closest('#inlineBack') : null;
    if(backBtn){
      if(dialog && dialog.style.display==='flex'){ closeDialog(); return; }
      setView('list');
    }
  });

  function renderList(){
    const list = el('listView'); if(!list) return; list.innerHTML='';
    if(!state.students.length){ list.innerHTML = `<div class="emptyState">Brak uczni√≥w.<br>Kliknij + aby dodaƒá.</div>`; return; }
    list.innerHTML = `<div class="studentCount">Liczba uczni√≥w: ${state.students.length}</div>`;
    const sorted = state.students.slice().sort((a,b)=> (a.order??0)-(b.order??0));
    sorted.forEach(s=>{
      const card = document.createElement('div'); card.className='card'; card.dataset.id=s.id;
      const initials=(s.name||'?').split(' ').map(x=>x[0]).slice(0,2).join('').toUpperCase();
      const avatar = s.avatar? `<img src="${s.avatar}" alt="">` : initials;
      const handleSvg = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M11 18c0 1.1-.9 2-2 2s-2-.9-2-2 .9-2 2-2 2 .9 2 2zm-2-8c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0-6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm6 4c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>`;
      card.innerHTML = `
        <div class="drag-handle" title="Zmie≈Ñ kolejno≈õƒá">${handleSvg}</div>
        <div class="avatar">${avatar}</div>
        <div class="meta"><div class="name">${escapeHtml(s.name)}</div><div class="sub">${escapeHtml(s.place||'‚Äî')}</div></div>
        <div class="amount ${s.balance>0?'pos':(s.balance<0?'neg':'')}">${formatPLN(s.balance)}</div>`;
      enableCardDnD(card, s.id);
      list.appendChild(card);
    });
  }

  let dragEl=null, placeholder=null, startX=0, startY=0, offsetY=0, lpTimer=null, dragStarted=false;
  const LP_MS=450, SLOP=8;
  function enableCardDnD(card, id) {
    const handle = card.querySelector('.drag-handle');
    const list = el('listView');

    // Click on card to select
    card.addEventListener('click', (e) => {
        if (e.target.closest('.drag-handle')) return;
        selectStudent(id);
    });

    // Drag from handle
    handle.addEventListener('pointerdown', e => {
        if (e.pointerType === 'mouse' && e.button !== 0) return; // Only left mouse button
        e.preventDefault();
        e.stopPropagation();
        startDrag(card, e);
        handle.setPointerCapture(e.pointerId);
    });

    handle.addEventListener('pointermove', e => {
        if (dragEl) moveDrag(e);
    });

    const endDragHandler = () => {
        if (dragEl) endDrag();
    };
    handle.addEventListener('pointerup', endDragHandler);
    handle.addEventListener('pointercancel', endDragHandler);

    // --- DnD Helper Functions (Copied from original) ---
    function startDrag(node, e) {
        dragEl = node;
        dragEl.classList.add('dragging');
        const r = dragEl.getBoundingClientRect();
        offsetY = e.clientY - r.top;
        placeholder = document.createElement('div');
        placeholder.className = 'placeholder';
        placeholder.style.height = r.height + 'px';
        dragEl.parentNode.insertBefore(placeholder, dragEl.nextSibling);
        dragEl.style.position = 'fixed';
        dragEl.style.left = r.left + 'px';
        dragEl.style.width = r.width + 'px';
        dragEl.style.top = r.top + 'px';
        dragEl.style.zIndex = 50;
        document.body.appendChild(dragEl);
        moveDrag(e);
    }

    function moveDrag(e) {
        if (!dragEl) return;
        dragEl.style.top = (e.clientY - offsetY) + 'px';
        const cards = Array.from(list.children).filter(x => x !== placeholder && !x.classList.contains('dragging'));
        const midY = e.clientY;
        let target = null;
        for (const c of cards) {
            const r = c.getBoundingClientRect();
            if (midY < r.top + r.height / 2) {
                target = c;
                break;
            }
        }
        if (target) {
            list.insertBefore(placeholder, target);
        } else {
            list.appendChild(placeholder);
        }
    }

    function endDrag() {
        if (!dragEl) return;
        placeholder.parentNode.insertBefore(dragEl, placeholder);
        dragEl.style.position = '';
        dragEl.style.left = '';
        dragEl.style.top = '';
        dragEl.style.width = '';
        dragEl.style.zIndex = '';
        dragEl.classList.remove('dragging');
        placeholder.remove();
        
        const ids = Array.from(el('listView').children).map(x => x.dataset.id).filter(Boolean);
        ids.forEach((sid, i) => {
            const s = state.students.find(o => o.id === sid);
            if (s) s.order = i;
        });
        save();
        dragEl = null;
        placeholder = null;
        renderList();
    }
  }

  function escapeHtml(str){ return (str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  function selectStudent(id){
    currentId=id; const s=state.students.find(x=>x.id===id); if(!s) return;
    setView('detail'); setReadOnly(true);
    el('dName').value=s.name||''; 
    el('dPlace').value=s.place||''; 
    el('dNotes').value=s.notes||'';
    el('dLocation').value=s.place||'';
    updateNotesDisplay();
    renderAvatar(s); renderBalance(s.balance); updateMap(s.place); renderActiveSummary();
    safePush('#detail-'+id, {screen:'detail', id}); // no-op in sandbox

    const mapWrap = el('map').parentNode;
    if (mapWrap) mapWrap.style.display = 'none';
    const toggleBtn = el('toggleMapBtn');
    if (toggleBtn) toggleBtn.textContent = 'Poka≈º mapƒô';
  }

  function renderAvatar(s){ const dA=el('dAvatar'); dA.innerHTML=''; if(s.avatar){ const img=document.createElement('img'); img.src=s.avatar; img.alt='avatar'; dA.appendChild(img);} else { dA.textContent=(s.name||'?').split(' ').map(x=>x[0]).slice(0,2).join('').toUpperCase(); } }
  function renderBalance(val){ const b=el('dBalance'); b.textContent=formatPLN(val); b.classList.remove('pos','neg'); if(val>0)b.classList.add('pos'); if(val<0)b.classList.add('neg'); evaluateFree(); }
  function setReadOnly(ro){ el('detailView').classList.toggle('readonly', !!ro); }
  function updateMap(place){ const map=el('map'); const q=encodeURIComponent(place||'Polska'); map.src=`https://maps.google.com/maps?q=${q}&z=14&output=embed`; }

  // Update notes display and toggle expandable
  function updateNotesDisplay(){
    const notes = el('dNotes').value || '';
    const notesToggle = el('notesToggle');
    const display = el('dNotesDisplay');
    if(display) display.textContent = notes;
    if(notesToggle) notesToggle.style.display = notes.length > 0 ? 'block' : 'none';
    // Reset to collapsed state (3 linijki) when loading student
    if(notesToggle) notesToggle.classList.remove('expanded');
    if(display) display.classList.remove('show');
  }

  // Notes toggle handler - expand/collapse
  el('notesToggle')?.addEventListener('click', ()=>{
    const notesToggle = el('notesToggle');
    const display = el('dNotesDisplay');
    if(notesToggle) notesToggle.classList.toggle('expanded');
    if(display) display.classList.toggle('show');
  });

  ['dName','dPlace','dNotes'].forEach(id=>{ el(id).addEventListener('input',()=>{ 
    if(el('detailView').classList.contains('readonly')) { if(id==='dNotes') updateNotesDisplay(); return; }
    const s=state.students.find(x=>x.id===currentId); if(!s) return; 
    s.name=el('dName').value.trim(); 
    s.place=el('dPlace').value.trim(); 
    s.notes=el('dNotes').value.trim(); 
    el('dLocation').value=s.place;
    save(); renderList(); updateMap(s.place); renderAvatar(s); renderActiveSummary(); updateNotesDisplay();
  }); });

  // Sync dLocation display with dPlace
  el('dPlace')?.addEventListener('input', ()=>{ 
    el('dLocation').value = el('dPlace').value;
  });

  function getActivePrice(){ const s=state.students.find(x=>x.id===currentId); if(!s) return 0; const key=(s.active?.type==='station'?'station':'remote')+String(s.active?.dur||60); const v=s.pricing?.[key]??0; return Number(v)||0; }
  function renderActiveSummary(){ const s=state.students.find(x=>x.id===currentId); if(!s) return; const typeLabel=(s.active?.type==='station')?'Stacjonarne':'Zdalne'; const dur=s.active?.dur||60; const price=getActivePrice(); const badge=el('activeBadge'); const priceBadge=el('priceBadge'); if(badge) badge.textContent=`Aktywne: ${typeLabel} ‚Äî ${dur} min`; if(priceBadge) priceBadge.textContent=`Cena: ${price?formatPLN(price):'‚Äî'}`; evaluateFree(); }
  function evaluateFree(){ const s=state.students.find(x=>x.id===currentId); if(!s) return; const p=getActivePrice(); const wrap=el('balanceWrap'); const badge=el('freeBadge'); const ok=p>0 && s.balance===p; if(wrap) wrap.classList.toggle('highlight', ok); if(badge) badge.style.display= ok? 'inline-block':'none'; }

  function applyDelta(d){ const s=state.students.find(x=>x.id===currentId); if(!s) return; s.balance=Math.round(s.balance+d); save(); renderBalance(s.balance); renderList(); }
  function resetBalance(){ const s=state.students.find(x=>x.id===currentId); if(!s) return; s.balance=0; save(); renderBalance(s.balance); renderList(); }

  const dialog=el('dialogWrap');
  function updateAvatarPreviewFrom(name, dataurl){
    const prev = el('avatarPreview'); if(!prev) return;
    prev.innerHTML='';
    if(dataurl){ const img=document.createElement('img'); img.src=dataurl; img.alt='avatar'; prev.appendChild(img); return; }
    const initials=(name||'')?.split(' ').map(x=>x[0]).slice(0,2).join('').toUpperCase() || 'A';
    prev.textContent=initials;
  }

  function openDialog(editId){ if(!dialog) return; dialog.style.display='flex';
    const title=el('dialogTitle'); const sName=el('sName'); const sPlace=el('sPlace'); const sNotes=el('sNotes');
    const pR60=el('priceR60'); const pR90=el('priceR90'); const pR120=el('priceR120'); const pS60=el('priceS60'); const pS90=el('priceS90'); const pS120=el('priceS120');
    const aInfo=el('avatarInfo'); const aType=el('activeType'); const aDur=el('activeDur'); const delBtn=el('deleteBtn');

    if(editId){ const s=state.students.find(x=>x.id===editId); if(!s) return;
      title && (title.textContent='Edytuj ucznia'); sName && (sName.value=s.name||''); sPlace && (sPlace.value=s.place||''); sNotes && (sNotes.value=s.notes||'');
      pR60 && (pR60.value=s.pricing?.remote60??''); pR90 && (pR90.value=s.pricing?.remote90??''); pR120 && (pR120.value=s.pricing?.remote120??'');
      pS60 && (pS60.value=s.pricing?.station60??''); pS90 && (pS90.value=s.pricing?.station90??''); pS120 && (pS120.value=s.pricing?.station120??'');
      aInfo && (aInfo.textContent=s.avatar?'ustawiono':'(opcjonalnie)');
      aType && (aType.value=s.active?.type||'remote'); aDur && (aDur.value=String(s.active?.dur||60)); dialog.dataset.editId=editId;
      if(delBtn) delBtn.style.display='inline-flex';
      updateAvatarPreviewFrom(s.name, s.avatar);
    } else {
      title && (title.textContent='Nowy ucze≈Ñ'); sName && (sName.value=''); sPlace && (sPlace.value=''); sNotes && (sNotes.value='');
      pR60 && (pR60.value=''); pR90 && (pR90.value=''); pR120 && (pR120.value=''); pS60 && (pS60.value=''); pS90 && (pS90.value=''); pS120 && (pS120.value='');
      aInfo && (aInfo.textContent='(opcjonalnie)'); aType && (aType.value='remote'); aDur && (aDur.value='60'); delete dialog.dataset.editId;
      if(delBtn) delBtn.style.display='none';
      updateAvatarPreviewFrom('', null);
    }
    setTimeout(()=>sName&&sName.focus(),50);
  }
  function closeDialog(){ dialog && (dialog.style.display='none'); }
  function closeIncomeDialog(){ const incomeDialog=el('incomeDialogWrap'); if(incomeDialog) incomeDialog.style.display='none'; }
  
  el('addBtn')?.addEventListener('click',()=>{ 
    if(currentView==='students'){ openDialog(); } 
    else if(currentView==='stats'){ openIncomeDialog(); }
  });

  // Month navigation for stats
  el('prevMonth')?.addEventListener('click', ()=>{
    const monthDisplay = el('monthDisplay');
    if(!monthDisplay) return;
    const monthStr = monthDisplay.textContent;
    const [monthName, yearStr] = monthStr.split(' ');
    const monthMap = {'stycze≈Ñ':1, 'luty':2, 'marzec':3, 'kwiecie≈Ñ':4, 'maj':5, 'czerwiec':6, 'lipiec':7, 'sierpie≈Ñ':8, 'wrzesie≈Ñ':9, 'pa≈∫dziernik':10, 'listopad':11, 'grudzie≈Ñ':12};
    const monthInv = {1:'stycze≈Ñ', 2:'luty', 3:'marzec', 4:'kwiecie≈Ñ', 5:'maj', 6:'czerwiec', 7:'lipiec', 8:'sierpie≈Ñ', 9:'wrzesie≈Ñ', 10:'pa≈∫dziernik', 11:'listopad', 12:'grudzie≈Ñ'};
    let month = monthMap[monthName.toLowerCase()] || 10;
    let year = parseInt(yearStr) || 2025;
    month--; if(month < 1){ month = 12; year--; }
    monthDisplay.textContent = monthInv[month] + ' ' + year;
    renderStats(); renderEarnings();
  });

  el('nextMonth')?.addEventListener('click', ()=>{
    const monthDisplay = el('monthDisplay');
    if(!monthDisplay) return;
    const monthStr = monthDisplay.textContent;
    const [monthName, yearStr] = monthStr.split(' ');
    const monthMap = {'stycze≈Ñ':1, 'luty':2, 'marzec':3, 'kwiecie≈Ñ':4, 'maj':5, 'czerwiec':6, 'lipiec':7, 'sierpie≈Ñ':8, 'wrzesie≈Ñ':9, 'pa≈∫dziernik':10, 'listopad':11, 'grudzie≈Ñ':12};
    const monthInv = {1:'stycze≈Ñ', 2:'luty', 3:'marzec', 4:'kwiecie≈Ñ', 5:'maj', 6:'czerwiec', 7:'lipiec', 8:'sierpie≈Ñ', 9:'wrzesie≈Ñ', 10:'pa≈∫dziernik', 11:'listopad', 12:'grudzie≈Ñ'};
    let month = monthMap[monthName.toLowerCase()] || 10;
    let year = parseInt(yearStr) || 2025;
    month++; if(month > 12){ month = 1; year++; }
    monthDisplay.textContent = monthInv[month] + ' ' + year;
    renderStats(); renderEarnings();
  });

  // Month selector modal
  let selectedYearInModal = new Date().getFullYear();
  
  el('monthDisplay')?.addEventListener('click', openMonthSelector);
  el('monthSelectorWrap')?.addEventListener('click', (e) => {
    if(e.target === el('monthSelectorWrap')) closeMonthSelector();
  });
  el('yearSelectorWrap')?.addEventListener('click', (e) => {
    if(e.target === el('yearSelectorWrap')) closeYearSelector();
  });

  function openMonthSelector(){
    const monthDisplay = el('monthDisplay');
    const monthStr = monthDisplay.textContent;
    const [monthName, yearStr] = monthStr.split(' ');
    const monthMap = {'stycze≈Ñ':1, 'luty':2, 'marzec':3, 'kwiecie≈Ñ':4, 'maj':5, 'czerwiec':6, 'lipiec':7, 'sierpie≈Ñ':8, 'wrzesie≈Ñ':9, 'pa≈∫dziernik':10, 'listopad':11, 'grudzie≈Ñ':12};
    const monthInv = {1:'stycze≈Ñ', 2:'luty', 3:'marzec', 4:'kwiecie≈Ñ', 5:'maj', 6:'czerwiec', 7:'lipiec', 8:'sierpie≈Ñ', 9:'wrzesie≈Ñ', 10:'pa≈∫dziernik', 11:'listopad', 12:'grudzie≈Ñ'};
    const currentMonth = monthMap[monthName.toLowerCase()] || 10;
    const year = parseInt(yearStr) || 2025;
    
    selectedYearInModal = year;
    el('yearDisplay').textContent = year;
    
    // Chart will use the year from monthDisplay selector
    
    renderMonthGrid(year, currentMonth);
    el('monthSelectorWrap').style.display = 'flex';
  }

  function renderMonthGrid(year, currentMonth){
    const monthInv = {1:'stycze≈Ñ', 2:'luty', 3:'marzec', 4:'kwiecie≈Ñ', 5:'maj', 6:'czerwiec', 7:'lipiec', 8:'sierpie≈Ñ', 9:'wrzesie≈Ñ', 10:'pa≈∫dziernik', 11:'listopad', 12:'grudzie≈Ñ'};
    const grid = el('monthSelectorGrid');
    grid.innerHTML = '';
    
    const today = new Date();
    const todayMonth = today.getMonth() + 1;
    const todayYear = today.getFullYear();
    
    for(let m = 1; m <= 12; m++){
      const monthNameStr = monthInv[m];
      let totalEarnings = 0;
      
      (state.earnings || []).forEach(entry => {
        const d = new Date(entry.date + 'T00:00:00');
        if(d.getMonth() + 1 === m && d.getFullYear() === year){
          totalEarnings += entry.amount;
        }
      });
      
      const btn = document.createElement('button');
      btn.className = 'monthBtn';
      if(m === currentMonth) btn.classList.add('active');
      if(m === todayMonth && year === todayYear) btn.classList.add('current');
      btn.innerHTML = `<div style="font-weight:700">${monthNameStr}</div><div style="font-size:11px; opacity:0.8">${formatPLN(totalEarnings)}</div>`;
      btn.addEventListener('click', () => selectMonth(m, year, currentMonth));
      grid.appendChild(btn);
    }
  }

  function closeMonthSelector(){
    el('monthSelectorWrap').style.display = 'none';
  }

  function openYearSelector(){
    const today = new Date();
    const currentYear = today.getFullYear();
    const dropdown = el('yearDropdown');
    dropdown.innerHTML = '';
    
    // Generate years from currentYear - 5 to currentYear + 5
    for(let y = currentYear - 5; y <= currentYear + 5; y++){
      const option = document.createElement('button');
      option.className = 'yearOption';
      if(y === selectedYearInModal) option.classList.add('active');
      option.textContent = y;
      option.addEventListener('click', () => selectYear(y));
      dropdown.appendChild(option);
    }
    
    el('yearSelectorWrap').style.display = 'flex';
  }

  function closeYearSelector(){
    el('yearSelectorWrap').style.display = 'none';
  }

  function selectYear(year){
    selectedYearInModal = year;
    el('yearDisplay').textContent = year;
    const monthDisplay = el('monthDisplay');
    const monthStr = monthDisplay.textContent;
    const [monthName] = monthStr.split(' ');
    const monthMap = {'stycze≈Ñ':1, 'luty':2, 'marzec':3, 'kwiecie≈Ñ':4, 'maj':5, 'czerwiec':6, 'lipiec':7, 'sierpie≈Ñ':8, 'wrzesie≈Ñ':9, 'pa≈∫dziernik':10, 'listopad':11, 'grudzie≈Ñ':12};
    const currentMonth = monthMap[monthName.toLowerCase()] || 10;
    renderMonthGrid(year, currentMonth);
    closeYearSelector();
  }

  function selectMonth(month, year, currentMonth){
    const monthInv = {1:'stycze≈Ñ', 2:'luty', 3:'marzec', 4:'kwiecie≈Ñ', 5:'maj', 6:'czerwiec', 7:'lipiec', 8:'sierpie≈Ñ', 9:'wrzesie≈Ñ', 10:'pa≈∫dziernik', 11:'listopad', 12:'grudzie≈Ñ'};
    el('monthDisplay').textContent = monthInv[month] + ' ' + year;
    renderStats(); renderEarnings();
    closeMonthSelector();
  }

  function goToToday(){
    const today = new Date();
    const todayMonth = today.getMonth() + 1;
    const todayYear = today.getFullYear();
    const monthInv = {1:'stycze≈Ñ', 2:'luty', 3:'marzec', 4:'kwiecie≈Ñ', 5:'maj', 6:'czerwiec', 7:'lipiec', 8:'sierpie≈Ñ', 9:'wrzesie≈Ñ', 10:'pa≈∫dziernik', 11:'listopad', 12:'grudzie≈Ñ'};
    el('monthDisplay').textContent = monthInv[todayMonth] + ' ' + todayYear;
    renderStats(); renderEarnings();
    closeMonthSelector();
  }

  // Initialize stats view with current month and year on app start
  (function initializeCurrentMonth(){
    const monthDisplay = el('monthDisplay');
    if(monthDisplay && monthDisplay.textContent.includes('pa≈∫dziernik 2025')){
      const today = new Date();
      const todayMonth = today.getMonth() + 1;
      const todayYear = today.getFullYear();
      const monthInv = {1:'stycze≈Ñ', 2:'luty', 3:'marzec', 4:'kwiecie≈Ñ', 5:'maj', 6:'czerwiec', 7:'lipiec', 8:'sierpie≈Ñ', 9:'wrzesie≈Ñ', 10:'pa≈∫dziernik', 11:'listopad', 12:'grudzie≈Ñ'};
      monthDisplay.textContent = monthInv[todayMonth] + ' ' + todayYear;
    }
  })();
  el('editBtn')?.addEventListener('click',()=>{ if(currentId){ openDialog(currentId); setReadOnly(false);} });
  el('cancelDialog')?.addEventListener('click',()=>{ closeDialog(); });
  el('deleteBtn')?.addEventListener('click',()=>{
    if(!dialog?.dataset.editId) return;
    pendingDeleteId = dialog.dataset.editId;
    const s = state.students.find(x=>x.id===pendingDeleteId);
    const name = s?.name || 'tego ucznia';
    const txt = el('confirmText'); if(txt) txt.textContent = `Na pewno chcesz usunƒÖƒá "${name}"? Tej operacji nie mo≈ºna cofnƒÖƒá.`;
    const cw = el('confirmWrap'); if(cw) cw.style.display='flex';
  });
  el('confirmCancel')?.addEventListener('click',()=>{ pendingDeleteId=null; const cw=el('confirmWrap'); if(cw) cw.style.display='none'; });
  el('confirmDelete')?.addEventListener('click',()=>{
    if(!pendingDeleteId) return;
    state.students = state.students.filter(x=>x.id!==pendingDeleteId);
    save(); pendingDeleteId=null;
    const cw=el('confirmWrap'); if(cw) cw.style.display='none';
    closeDialog(); setView('list'); currentId=null; renderList();
  });

  // Avatar upload UX
  el('avatarUpload')?.addEventListener('click',()=> el('sAvatar')?.click());
  el('avatarPick')?.addEventListener('click',(e)=>{ e.stopPropagation(); el('sAvatar')?.click(); });
  el('sAvatar')?.addEventListener('change', (e)=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ const info=el('avatarInfo'); if(info){ info.textContent='wybrano'; info.dataset.dataurl=r.result; } updateAvatarPreviewFrom(el('sName')?.value, r.result); }; r.readAsDataURL(f); });

  el('confirmDialog')?.addEventListener('click',()=>{
    const name=el('sName')?.value.trim(); if(!name){ alert('Podaj imiƒô i nazwisko'); return; }
    const place=el('sPlace')?.value.trim(); const notes=el('sNotes')?.value.trim();
    const pricing={ remote60:numOrNull(el('priceR60')?.value), remote90:numOrNull(el('priceR90')?.value), remote120:numOrNull(el('priceR120')?.value), station60:numOrNull(el('priceS60')?.value), station90:numOrNull(el('priceS90')?.value), station120:numOrNull(el('priceS120')?.value)};
    const avatar=el('avatarInfo')?.dataset.dataurl; const active={ type:el('activeType')?.value, dur:Number(el('activeDur')?.value) };

    if(dialog?.dataset.editId){
      const s=state.students.find(x=>x.id===dialog.dataset.editId); if(!s) return; s.name=name; s.place=place; s.notes=notes; s.pricing={...(s.pricing||{}),...pricing}; s.active=active; if(avatar) s.avatar=avatar; save(); if(currentId===s.id){ selectStudent(s.id);} }
    else { const order=(state.students.reduce((m,x)=>Math.max(m,x.order??-1),-1)+1); state.students.push({id:uid(), order, name, place, notes, balance:0, pricing, avatar, active}); save(); }
    closeDialog(); renderList();
  });
  function numOrNull(v){ const n=Number(v); return isNaN(n)? null:n; }

  el('plus10')?.addEventListener('click',()=>applyDelta(10));
  el('minus10')?.addEventListener('click',()=>applyDelta(-10));
  el('resetBtn')?.addEventListener('click',resetBalance);
  el('addPlus')?.addEventListener('click',()=>{ const v=Number(el('customAmount')?.value); if(!v) return; applyDelta(Math.abs(v)); el('customAmount') && (el('customAmount').value=''); });
  el('addMinus')?.addEventListener('click',()=>{ const v=Number(el('customAmount')?.value); if(!v) return; applyDelta(-Math.abs(v)); el('customAmount') && (el('customAmount').value=''); });

  // Export/Import handlers
  const exportFunc = ()=>{ const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='tuttorly-data.json'; a.click(); URL.revokeObjectURL(url); };
  const importFunc = (fileInputId)=>{ const fileInput=el(fileInputId); if(!fileInput) return; const file=fileInput.files[0]; if(!file) return; const reader=new FileReader(); reader.onload=()=>{ try{ const data=JSON.parse(reader.result); if(!data||!Array.isArray(data.students)) throw new Error('Z≈Çy format pliku'); data.students.forEach((s,i)=>{ if(typeof s.order!=="number") s.order=i; }); state=data; save(); renderList(); setView('list'); currentId=null; alert('Zaimportowano dane.'); closeSettingsDialog(); }catch(err){ alert('B≈ÇƒÖd importu: '+err.message);} }; reader.readAsText(file); fileInput.value=''; };
  
  el('exportBtn')?.addEventListener('click', exportFunc);
  el('settingsExportBtn')?.addEventListener('click', exportFunc);
  el('importFile')?.addEventListener('change', (e)=>importFunc('importFile'));
  el('settingsImportFile')?.addEventListener('change', (e)=>importFunc('settingsImportFile'));

  // Settings modal handlers
  function openSettingsDialog(){ el('settingsDialogWrap').style.display='flex'; }
  function closeSettingsDialog(){ el('settingsDialogWrap').style.display='none'; }
  
    // Support modal handlers
  function openSupportDialog(){ el('supportDialogWrap').style.display='flex'; }
  function closeSupportDialog(){ el('supportDialogWrap').style.display='none'; }
  
  el('supportBtn')?.addEventListener('click', openSupportDialog);
  el('supportCloseBtn')?.addEventListener('click', closeSupportDialog);
  el('supportDialogWrap')?.addEventListener('click', (e)=>{ if(e.target===el('supportDialogWrap')) closeSupportDialog(); });

  el('settingsBtn')?.addEventListener('click', openSettingsDialog);

  el('settingsCloseBtn')?.addEventListener('click', closeSettingsDialog);
  el('settingsDialogWrap')?.addEventListener('click', (e)=>{ if(e.target===el('settingsDialogWrap')) closeSettingsDialog(); });

  // Calendar button (placeholder for future functionality)
  el('calendarBtn')?.addEventListener('click', ()=>{ console.log('Calendar button clicked'); });

  el('toggleMapBtn')?.addEventListener('click', () => {
    const mapWrap = el('map').parentNode;
    const isHidden = mapWrap.style.display === 'none';
    mapWrap.style.display = isHidden ? 'block' : 'none';
    el('toggleMapBtn').textContent = isHidden ? 'Ukryj mapƒô' : 'Poka≈º mapƒô';
  });

  // --- INCOME ENTRIES LOGIC ---
  let pendingIncomeDeleteId = null;
  let currentIncomeType = 'cash';
  let chartYear = new Date().getFullYear();
  
  function setTodayDate(){
    const today = new Date().toISOString().split('T')[0];
    el('incomeDate').value = today;
  }

  function updateIncomeTypeButtons(type){
    currentIncomeType = type;
    el('incomeType').value = type;
    document.querySelectorAll('.incomeTypeBtn').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.type === type);
    });
  }

  function openIncomeDialog(editId){
    const incomeDialog = el('incomeDialogWrap');
    if(!incomeDialog) return;
    incomeDialog.style.display='flex';
    
    const title = el('incomeDialogTitle');
    const amount = el('incomeAmount');
    const date = el('incomeDate');
    const desc = el('incomeDesc');
    const delBtn = el('incomeDeleteBtn');

    if(editId){
      const entry = state.earnings.find(e => e.id === editId);
      if(!entry) return;
      title && (title.textContent = 'Edytuj wpis dochod√≥w');
      amount && (amount.value = entry.amount);
      updateIncomeTypeButtons(entry.type);
      date && (date.value = entry.date);
      desc && (desc.value = entry.description || '');
      if(delBtn) delBtn.style.display = 'inline-flex';
      incomeDialog.dataset.editId = editId;
    } else {
      title && (title.textContent = 'Nowy wpis dochod√≥w');
      amount && (amount.value = '');
      updateIncomeTypeButtons('cash');
      desc && (desc.value = '');
      setTodayDate();
      if(delBtn) delBtn.style.display = 'none';
      delete incomeDialog.dataset.editId;
    }
    setTimeout(() => amount && amount.focus(), 50);
  }

  function renderStats(){
    const monthStr = el('monthDisplay')?.textContent || '';
    const [monthName, yearStr] = monthStr.split(' ');
    const monthMap = {'stycze≈Ñ':1, 'luty':2, 'marzec':3, 'kwiecie≈Ñ':4, 'maj':5, 'czerwiec':6, 'lipiec':7, 'sierpie≈Ñ':8, 'wrzesie≈Ñ':9, 'pa≈∫dziernik':10, 'listopad':11, 'grudzie≈Ñ':12};
    const month = monthMap[monthName.toLowerCase()] || 10;
    const year = parseInt(yearStr) || 2025;
    
    // Monthly totals
    let total = 0, online = 0, cash = 0;
    
    // Annual totals
    let annualTotal = 0, annualOnline = 0, annualCash = 0;
    
    (state.earnings || []).forEach(entry => {
      const d = new Date(entry.date + 'T00:00:00');
      const entryYear = d.getFullYear();
      const entryMonth = d.getMonth() + 1;
      
      // Monthly calculation
      if(entryMonth === month && entryYear === year){
        total += entry.amount;
        if(entry.type === 'cash') cash += entry.amount;
        else online += entry.amount;
      }
      
      // Annual calculation (only for current year)
      if(entryYear === year){
        annualTotal += entry.amount;
        if(entry.type === 'cash') annualCash += entry.amount;
        else annualOnline += entry.amount;
      }
    });
    
    // Update monthly stats
    el('totalAmount').textContent = formatPLN(total);
    el('onlineAmount').textContent = formatPLN(online);
    el('cashAmount').textContent = formatPLN(cash);
    
    // Update annual stats
    el('annualTotal').textContent = formatPLN(annualTotal);
    el('annualOnline').textContent = formatPLN(annualOnline);
    el('annualCash').textContent = formatPLN(annualCash);
    
    // Update stat bars
    const onlineBar = el('onlineBar');
    const cashBar = el('cashBar');
    if(onlineBar) onlineBar.style.width = total > 0 ? (online / total * 100) + '%' : '0%';
    if(cashBar) cashBar.style.width = total > 0 ? (cash / total * 100) + '%' : '0%';
    
    // Draw chart for the entire selected year
    drawChart(year);
  }



  function drawChart(year){
    const canvas = el('earningsChart');
    if(!canvas) return;
    
    const ctx = canvas.getContext('2d');
    const rect = canvas.getBoundingClientRect();
    canvas.width = rect.width;
    canvas.height = rect.height;
    
    const monthInv = {1:'sty', 2:'lut', 3:'mar', 4:'kwi', 5:'maj', 6:'cze', 7:'lip', 8:'sie', 9:'wrz', 10:'pa≈∫', 11:'lis', 12:'gru'};
    
    // Get 12 months data for the selected year
    const months12 = [];
    
    for(let m = 0; m < 12; m++){
      const d = new Date(year, m, 1);
      months12.push({month: d.getMonth() + 1, year: d.getFullYear()});
    }
    
    // Collect earnings by month and type
    const monthsData = {};
    months12.forEach(m => {
      monthsData[`${m.year}-${m.month}`] = {cash: 0, card: 0, total: 0};
    });
    
    (state.earnings || []).forEach(entry => {
      const d = new Date(entry.date + 'T00:00:00');
      const key = `${d.getFullYear()}-${d.getMonth() + 1}`;
      if(monthsData[key]){
        const type = entry.type === 'cash' ? 'cash' : 'card';
        monthsData[key][type] += entry.amount;
        monthsData[key].total += entry.amount;
      }
    });
    
    const maxVal = Math.max(...Object.values(monthsData).map(m => m.total), 1);
    
    // Padding and dimensions - different for each side
    const padLeft = 50;
    const padRight = 20;
    const padTop = 28;
    const padBottom = 28;
    const w = canvas.width - padLeft - padRight;
    const h = canvas.height - padTop - padBottom;
    const barWidth = w / 12;
    
    // Colors
    const colors = {cash: '#22c55e', card: '#5dd7ef'};
    
    // Draw grid
    ctx.strokeStyle = 'rgba(255,255,255,0.08)';
    ctx.font = '10px system-ui';
    ctx.fillStyle = 'rgba(154, 163, 173, 0.7)';
    
    // Y-axis labels and grid
    for(let i = 0; i <= 5; i++){
      const val = (maxVal / 5) * i;
      const y = padTop + h - (i / 5) * h;
      ctx.fillText(val.toFixed(0) + ' z≈Ç', 3, y + 4);
      ctx.strokeStyle = 'rgba(255,255,255,0.05)';
      ctx.beginPath();
      ctx.moveTo(padLeft, y);
      ctx.lineTo(canvas.width - padRight, y);
      ctx.stroke();
    }
    
    // Draw bars
    const today = new Date();
    const todayMonth = today.getMonth() + 1;
    const todayYear = today.getFullYear();
    
    months12.forEach((m, idx) => {
      const key = `${m.year}-${m.month}`;
      const data = monthsData[key];
      const x = padLeft + idx * barWidth + barWidth * 0.15;
      const barH = barWidth * 0.7;
      
      let stackY = 0;
      
      ['cash', 'card'].forEach(type => {
        const amount = data[type];
        const barHeight = (amount / maxVal) * h;
        const barY = padTop + h - stackY - barHeight;
        
        ctx.fillStyle = colors[type];
        ctx.fillRect(x, barY, barH, barHeight);
        
        stackY += barHeight;
      });
      
      // Month label - centered under bar area
      ctx.fillStyle = 'rgba(154, 163, 173, 0.75)';
      ctx.font = '10px system-ui';
      const label = monthInv[m.month];
      const labelX = padLeft + (idx + 0.5) * barWidth;
      ctx.textAlign = 'center';
      ctx.fillText(label, labelX, canvas.height - 10);
    });
    
    // Legend - at top
    const legendY = 12;
    ctx.font = '10px system-ui';
    ctx.textAlign = 'left';
    
    ctx.fillStyle = '#22c55e';
    ctx.fillRect(padLeft, legendY, 6, 6);
    ctx.fillStyle = 'rgba(154, 163, 173, 0.9)';
    ctx.fillText('Stacjonarnie', padLeft + 9, legendY + 5);
    
    ctx.fillStyle = '#5dd7ef';
    ctx.fillRect(padLeft + 110, legendY, 6, 6);
    ctx.fillStyle = 'rgba(154, 163, 173, 0.9)';
    ctx.fillText('Online', padLeft + 119, legendY + 5);
  }

  function renderEarnings(){
    const list = el('earningsList');
    if(!list) return;
    list.innerHTML = '';
    
    if(!state.earnings || state.earnings.length === 0){
      list.innerHTML = `<div class="emptyState">Brak wpis√≥w dochod√≥w.<br>Kliknij + aby dodaƒá.</div>`;
      return;
    }

    // Display all earnings sorted by date (without month filtering)
    const sorted = state.earnings.slice().sort((a, b) => new Date(b.date) - new Date(a.date));
    sorted.forEach(entry => {
      const card = document.createElement('div');
      card.className = 'card';
      card.dataset.id = entry.id;
      const typeLabel = entry.type === 'cash' ? 'üíµ' : 'üåê';
      const dateObj = new Date(entry.date + 'T00:00:00');
      const dateStr = dateObj.toLocaleDateString('pl-PL', {year:'numeric', month:'short', day:'numeric'});
      
      card.innerHTML = `
        <div style="flex:1">
          <div class="name">${formatPLN(entry.amount)} <span style="font-size:12px; color:var(--muted)">${typeLabel}</span></div>
          <div class="sub">${dateStr}${entry.description ? ' ‚Ä¢ ' + escapeHtml(entry.description) : ''}</div>
        </div>`;
      
      card.addEventListener('click', () => {
        openIncomeDialog(entry.id);
      });
      
      list.appendChild(card);
    });
  }

  const incomeDialog = el('incomeDialogWrap');
  
  // Handle income type button clicks
  document.querySelectorAll('.incomeTypeBtn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      const type = btn.dataset.type;
      updateIncomeTypeButtons(type);
    });
  });
  
  el('incomeCancelBtn')?.addEventListener('click', () => closeIncomeDialog());
  
  el('incomeConfirmBtn')?.addEventListener('click', () => {
    const amount = Number(el('incomeAmount')?.value);
    const type = el('incomeType')?.value || 'online';
    const date = el('incomeDate')?.value;
    const desc = el('incomeDesc')?.value.trim() || '';

    if(!amount || amount <= 0){
      alert('Podaj kwotƒô wiƒôkszƒÖ ni≈º 0');
      return;
    }
    if(!date){
      alert('Podaj datƒô');
      return;
    }

    if(incomeDialog?.dataset.editId){
      const entry = state.earnings.find(e => e.id === incomeDialog.dataset.editId);
      if(!entry) return;
      entry.amount = amount;
      entry.type = type;
      entry.date = date;
      entry.description = desc;
    } else {
      state.earnings.push({
        id: uid(),
        amount,
        type,
        date,
        description: desc,
        createdAt: new Date().toISOString()
      });
    }

    save();
    closeIncomeDialog();
    renderStats();
    renderEarnings();
  });

  el('incomeDeleteBtn')?.addEventListener('click', () => {
    if(!incomeDialog?.dataset.editId) return;
    pendingIncomeDeleteId = incomeDialog.dataset.editId;
    const entry = state.earnings.find(e => e.id === pendingIncomeDeleteId);
    const txt = `Na pewno chcesz usunƒÖƒá wpis ${formatPLN(entry?.amount || 0)}? Tej operacji nie mo≈ºna cofnƒÖƒá.`;
    if(confirm(txt)){
      state.earnings = state.earnings.filter(e => e.id !== pendingIncomeDeleteId);
      save();
      closeIncomeDialog();
      renderStats();
      renderEarnings();
    }
    pendingIncomeDeleteId = null;
  });

  // Prevent text selection and copying (except in input/textarea)
  document.addEventListener('copy', (e) => {
    if(e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA'){
      e.preventDefault();
    }
  });

  renderList();
  setView('list');
  updateMap('Polska');

  // (Optional) seed history when supported (no-op in sandbox)
  safeReplace(location.pathname + location.search, {screen:'list'});

  // ===== MOBILE BACK BUTTON HANDLING =====
  // Track view history for back button behavior
  let viewHistory = ['list'];
  let detailHistory = []; // Track which student detail views were opened

  // Override switchTab to update history
  const originalSwitchTab = switchTab;
  switchTab = function(tabName){
    originalSwitchTab(tabName);
    // Only add to history if different from last view
    if(viewHistory[viewHistory.length - 1] !== tabName){
      viewHistory.push(tabName);
      safePush(location.pathname + location.search, {screen: tabName});
    }
  };

  // Override setView to track detail view history
  const originalSetView = setView;
  setView = function(which){
    originalSetView(which);
    if(which === 'detail' && currentId){
      detailHistory.push(currentId);
    } else if(which === 'list'){
      detailHistory = [];
    }
  };

  // Handle browser back button and system back button
  function handleBackButton(){
    // Priority 1: Close day popup from calendar
    const dayPopups = document.querySelectorAll('.dialog-wrap');
    if(dayPopups.length > 0){
      dayPopups[dayPopups.length - 1].remove();
      return;
    }

    // Priority 1.5: Close calendar/schedule edit popups
    if(el('tempChangePlanWrap') && el('tempChangePlanWrap').style.display === 'flex'){
      el('tempChangePlanWrap').style.display = 'none';
      tempChangeFromDayPopup = false;
      return;
    }
    if(el('planEditWrap') && el('planEditWrap').style.display === 'flex'){
      el('planEditWrap').style.display = 'none';
      return;
    }

    // Priority 2: Close any open dialogs/modals
    if(el('supportDialogWrap') && el('supportDialogWrap').style.display === 'flex'){
      closeSupportDialog();
      return;
    }
    if(el('settingsDialogWrap') && el('settingsDialogWrap').style.display === 'flex'){
      closeSettingsDialog();
      return;
    }
    if(dialog && dialog.style.display === 'flex'){
      closeDialog();
      return;
    }
    if(el('incomeDialogWrap') && el('incomeDialogWrap').style.display === 'flex'){
      closeIncomeDialog();
      return;
    }
    if(el('monthSelectorWrap') && el('monthSelectorWrap').style.display === 'flex'){
      closeMonthSelector();
      return;
    }
    if(el('yearSelectorWrap') && el('yearSelectorWrap').style.display === 'flex'){
      closeYearSelector();
      return;
    }

    // Priority 3: If in detail view, go back to list
    if(el('detailView') && el('detailView').style.display === 'flex'){
      setView('list');
      currentId = null;
      detailHistory = [];
      return;
    }

    // Priority 4: If in stats tab, go back to students
    if(currentView === 'stats'){
      switchTab('students');
      return;
    }

    // Priority 5: In students view - browser back button works normally
    // (allow normal back navigation or exit)
  }

  // Listen for popstate (browser back button, history changes)
  window.addEventListener('popstate', (e)=>{
    handleBackButton();
  });

  // For Android back button when not in PWA mode
  // Some browsers fire beforeunload, but we'll handle it with popstate
  // For PWA standalone mode, the system handles it via history
  
  // Optional: Add support for keyboard Escape key as back
  document.addEventListener('keydown', (e)=>{
    if(e.key === 'Escape'){
      handleBackButton();
    }
  });

  // Register Service Worker for installability & offline
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      const swScope='/Tuttorly-Lite/';
      try{ navigator.serviceWorker.register(swScope + 'sw.js', { scope: swScope }); }catch(e){}
    });
  }

  // --- Add to Home Screen (A2HS) banner ---
  (function(){
    let deferredPrompt=null;
    const BAR = ()=>document.getElementById('installBar');
    const BTN = ()=>document.getElementById('installBtn');
    const TXT = ()=>document.getElementById('installText');
    const CLOSEI = ()=>document.getElementById('installClose');
    const isStandalone=()=> window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
    const isMobile=()=> /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

    function showBarAndroid(){ const bar=BAR(), txt=TXT(), btn=BTN(); if(!bar || localStorage.getItem('a2hs.dismissed')==='1') return; if(isStandalone()) return; bar.style.display='flex'; if(txt) txt.textContent='Zainstaluj Tuttorly na ekranie g≈Ç√≥wnym.'; if(btn) btn.style.display='inline-block'; }
    function showBarIOS(){ const bar=BAR(), txt=TXT(), btn=BTN(); if(!bar || localStorage.getItem('a2hs.dismissed')==='1') return; if(isStandalone()) return; bar.style.display='flex'; if(txt) txt.textContent='Na iOS: Udostƒôpnij ‚Üí ‚ÄûDo ekranu g≈Ç√≥wnego‚Äù.'; if(btn) btn.style.display='none'; }

    window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt=e; if(isMobile()) showBarAndroid(); });
    BTN()?.addEventListener('click', async ()=>{ if(!deferredPrompt) return; deferredPrompt.prompt(); const choice=await deferredPrompt.userChoice; deferredPrompt=null; const bar=BAR(); if(bar) bar.style.display='none'; if(choice && choice.outcome==='dismissed'){ localStorage.setItem('a2hs.dismissed','1'); }});
    CLOSEI()?.addEventListener('click', ()=>{ const bar=BAR(); if(bar) bar.style.display='none'; localStorage.setItem('a2hs.dismissed','1'); });
    window.addEventListener('appinstalled', ()=>{ const bar=BAR(); if(bar) bar.style.display='none'; localStorage.removeItem('a2hs.dismissed'); });
    window.addEventListener('load', ()=>{ const isiOS=/iPhone|iPad|iPod/i.test(navigator.userAgent); if(isiOS && isMobile() && !isStandalone()) showBarIOS(); });
  })();

  // ===== TERMINY VIEW =====
  const staticPlanKey = 'tuttorly.staticPlan';
  const tempChangesKey = 'tuttorly.tempChanges';

  // Default static plan data
  const defaultStaticPlan = [
    {
      day: 'Poniedzia≈Çek',
      dayNum: 1,
      lessons: [
        { id: 'p001', startTime: '15:45', endTime: '17:00', type: 'ZD', student: 'Jakub', note: 'Englilanka' },
        { id: 'p002', startTime: '17:15', endTime: '18:30', type: 'ZD', student: 'Natalia', note: 'Przyspieszony' }
      ]
    },
    { day: 'Wtorek', dayNum: 2, lessons: [] },
    { day: '≈öroda', dayNum: 3, lessons: [] },
    {
      day: 'Czwartek',
      dayNum: 4,
      lessons: [
        { id: 'c001', startTime: '16:00', endTime: '17:30', type: 'ST', student: 'Radek', note: 'Matematyka' },
        { id: 'c002', startTime: '17:45', endTime: '19:00', type: 'ST', student: 'RADEK', note: '' }
      ]
    },
    {
      day: 'PiƒÖtek',
      dayNum: 5,
      lessons: [
        { id: 'f001', startTime: '15:00', endTime: '16:00', type: 'ST', student: 'Ursuszek', note: 'Retorowana 4/6' },
        { id: 'f002', startTime: '16:30', endTime: '17:45', type: 'ST', student: 'Cecylia', note: 'Przydzielana 33 Lila 4/13dasdasdasdasdasdasdasdasdasdasdasdsssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssss' },
        { id: 'f003', startTime: '17:45', endTime: '19:00', type: 'ZD', student: 'Amelia', note: '' }
      ]
    },
    { day: 'Sobota', dayNum: 6, lessons: [] },
    {
      day: 'Niedziela',
      dayNum: 7,
      lessons: [
        { id: 'n001', startTime: '10:00', endTime: '11:30', type: 'ST', student: 'Moda Alicja', note: '' }
      ]
    }
  ];

  function loadStaticPlan(){
    const stored = localStorage.getItem(staticPlanKey);
    if(stored){
      try{ return JSON.parse(stored); }catch{}
    }
    return defaultStaticPlan;
  }

  function loadTempChanges(){
    const stored = localStorage.getItem(tempChangesKey);
    if(stored){
      try{ return JSON.parse(stored); }catch{}
    }
    return [];
  }

  function getToday(){
    const today = new Date();
    return today.getDay(); // 0=Sun, 1=Mon, ..., 6=Sat
  }

  function getTodayFromMonday(){
    // Convert JS day (0=Sun) to Polish week (1=Mon)
    const jsDay = getToday();
    return jsDay === 0 ? 7 : jsDay; // Convert Sunday (0) to 7
  }

  function renderWeek(){
    const container = el('weekContainer');
    if(!container) return;
    
    const staticPlan = loadStaticPlan();
    const tempChanges = loadTempChanges();
    const today = getTodayFromMonday();
    
    container.innerHTML = '';

    staticPlan.forEach(dayData => {
      const dayCard = document.createElement('div');
      dayCard.className = 'dayCard';
      if(dayData.dayNum === today) dayCard.classList.add('today');
      if(dayData.lessons.length === 0) dayCard.classList.add('empty');

      // Find temp changes for this day
      const tempChange = tempChanges.find(tc => {
        const tcDate = new Date(tc.date);
        const tcDayNum = tcDate.getDay() === 0 ? 7 : tcDate.getDay();
        return tcDayNum === dayData.dayNum;
      });

      const lessonsToShow = tempChange?.lessons || dayData.lessons;

      const dayHeader = document.createElement('div');
      dayHeader.className = 'dayHeader';
      if(dayData.dayNum === today) dayHeader.classList.add('today');
      dayHeader.textContent = dayData.day.substring(0, 3).toUpperCase();
      dayCard.appendChild(dayHeader);

      const lessonsList = document.createElement('div');
      lessonsList.className = 'lessonsList';

      if(lessonsToShow.length === 0){
        const emptyMsg = document.createElement('div');
        emptyMsg.className = 'emptyLessonMsg';
        emptyMsg.textContent = 'Brak zajƒôƒá';
        lessonsList.appendChild(emptyMsg);
      } else {
        lessonsToShow.forEach(lesson => {
          const item = document.createElement('div');
          item.className = 'lessonItem';

          let html = `<div><div class="lessonTime">${lesson.startTime}‚Äì${lesson.endTime}</div>`;
          html += `<div class="lessonTypeAndStudent">`;
          html += `<span class="lessonType ${lesson.type.toLowerCase()}">${lesson.type}</span>`;
          html += `<span class="lessonStudent">${lesson.student}</span>`;
          html += `</div></div>`;
          if(lesson.note) html += `<div class="lessonNote">${lesson.note}</div>`;

          item.innerHTML = html;
          lessonsList.appendChild(item);
        });
      }

      dayCard.appendChild(lessonsList);
      container.appendChild(dayCard);
    });
  }

  // ===== MONTHLY CALENDAR STATE =====
  let monthCalendarState = {
    year: new Date().getFullYear(),
    month: new Date().getMonth()
  };

  const MONTHS_PL = ['Stycze≈Ñ', 'Luty', 'Marzec', 'Kwiecie≈Ñ', 'Maj', 'Czerwiec', 'Lipiec', 'Sierpie≈Ñ', 'Wrzesie≈Ñ', 'Pa≈∫dziernik', 'Listopad', 'Grudzie≈Ñ'];
  const DAYS_SHORT = ['Pn', 'Wt', '≈ör', 'Cz', 'Pt', 'So', 'Nd'];

  function renderMonthCalendar(){
    const year = monthCalendarState.year;
    const month = monthCalendarState.month;
    
    // Update title
    el('monthTitleCal').textContent = `${year} ${MONTHS_PL[month].substring(0, 3).toUpperCase()}`;
    
    const staticPlan = loadStaticPlan();
    const tempChanges = loadTempChanges();
    const monthGrid = el('monthGrid');
    monthGrid.innerHTML = '';
    
    const firstDay = new Date(year, month, 1).getDay(); // 0=Sun, 1=Mon, etc.
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const daysInPrevMonth = new Date(year, month, 0).getDate();
    
    const startDate = firstDay === 0 ? daysInPrevMonth - 6 : firstDay - 1;
    
    let dayCounter = 1;
    let prevMonthDays = daysInPrevMonth - startDate + 1;
    let nextMonthDay = 1;
    
    for(let i = 0; i < 42; i++){
      let currentDate = null;
      let isCurrentMonth = false;
      let dayNum = 0;
      
      if(i < startDate){
        dayNum = prevMonthDays;
        prevMonthDays++;
      } else if(dayCounter <= daysInMonth){
        dayNum = dayCounter;
        isCurrentMonth = true;
        currentDate = new Date(year, month, dayCounter);
        dayCounter++;
      } else {
        dayNum = nextMonthDay;
        nextMonthDay++;
      }
      
      const cell = document.createElement('div');
      cell.className = 'dayCell';
      if(!isCurrentMonth) cell.classList.add('otherMonth');
      
      if(isCurrentMonth){
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(dayNum).padStart(2, '0')}`;
        
        // Check if this is today
        const today = new Date();
        if(currentDate.toDateString() === today.toDateString()){
          cell.classList.add('today');
        }
        
        // Check for temp changes
        const hasChange = tempChanges.some(tc => tc.date === dateStr);
        if(hasChange) cell.classList.add('hasChange');
        
        // Add click handler for current month days
        cell.addEventListener('click', () => showDayPopup(dateStr, dayNum, month, year));
      }
      
      const dayNumber = document.createElement('div');
      dayNumber.className = 'dayCellNumber';
      if(isCurrentMonth && currentDate.getDay() === 0) dayNumber.classList.add('weekend');
      if(isCurrentMonth && currentDate.getDay() === 6) dayNumber.classList.add('weekend');
      dayNumber.textContent = dayNum;
      cell.appendChild(dayNumber);
      
      // Add lesson indicators for current month
      if(isCurrentMonth){
        // Find the day of week for this date
        const jsDay = currentDate.getDay(); // 0=Sun, 1=Mon, etc.
        const dayOfWeek = jsDay === 0 ? 7 : jsDay;
        
        // Find corresponding static plan day
        const planDay = staticPlan.find(d => d.dayNum === dayOfWeek);
        
        // Check for temp changes
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(dayNum).padStart(2, '0')}`;
        const tempChange = tempChanges.find(tc => tc.date === dateStr);
        
        // Get actual lessons (temp changes take priority)
        const lessons = tempChange?.lessons || planDay?.lessons || [];
        
        if(lessons.length > 0){
          const indicators = document.createElement('div');
          indicators.className = 'dayCellIndicators';
          
          // Create single bar with color segments
          const bar = document.createElement('div');
          bar.className = 'lessonBar';
          
          // Build gradient with segments for each lesson
          const colors = [];
          const lessonCount = Math.min(lessons.length, 8);
          for(let j = 0; j < lessonCount; j++){
            const lesson = lessons[j];
            const color = lesson.type === 'ZD' ? 'var(--accent)' : 'var(--accent-2)';
            colors.push(color);
          }
          
          // Create linear gradient with equal segments and thin separator lines
          const separatorWidth = 2.5; // percentage points for separator
          const gradientStops = [];
          
          colors.forEach((color, i) => {
            const start = (i / colors.length) * 100;
            const end = ((i + 1) / colors.length) * 100;
            const adjustedEnd = end - (i < colors.length - 1 ? separatorWidth : 0);
            
            gradientStops.push(`${color} ${start}% ${adjustedEnd}%`);
            
            // Add separator line between segments (dark gray)
            if(i < colors.length - 1){
              gradientStops.push(`rgba(60,65,75,.9) ${adjustedEnd}% ${end}%`);
            }
          });
          
          bar.style.background = `linear-gradient(90deg, ${gradientStops.join(', ')})`;
          indicators.appendChild(bar);
          
          // Add "+X" badge if more lessons
          if(lessons.length > 8){
            const more = document.createElement('div');
            more.className = 'lessonMoreBadge';
            more.textContent = `+${lessons.length - 8}`;
            indicators.appendChild(more);
          }
          
          cell.appendChild(indicators);
        }
      }
      
      monthGrid.appendChild(cell);
    }
  }
  
  function showDayPopup(dateStr, dayNum, month, year){
    const date = new Date(year, month, dayNum);
    const staticPlan = loadStaticPlan();
    const tempChanges = loadTempChanges();
    
    // Find day of week
    const jsDay = date.getDay();
    const dayOfWeek = jsDay === 0 ? 7 : jsDay;
    const dayNames = ['Niedziela', 'Poniedzia≈Çek', 'Wtorek', '≈öroda', 'Czwartek', 'PiƒÖtek', 'Sobota'];
    
    // Get plan for this day
    const planDay = staticPlan.find(d => d.dayNum === dayOfWeek);
    const tempChange = tempChanges.find(tc => tc.date === dateStr);
    const lessons = tempChange?.lessons || planDay?.lessons || [];
    
    // Create popup
    const popup = document.createElement('div');
    popup.className = 'dialog-wrap';
    popup.style.display = 'flex';
    
    const dialog = document.createElement('div');
    dialog.className = 'dialog';
    
    let html = `<div style="display:flex; justify-content:space-between; align-items:flex-start; gap:12px; margin-bottom:8px">`;
    html += `<div><h3 style="margin:0 0 4px 0">${dayNames[jsDay]} ${dayNum} ${MONTHS_PL[month]}</h3>`;
    html += `<p style="color:var(--muted); font-size:12px; margin:0">${tempChange ? '‚öôÔ∏è Zmiana tymczasowa' : 'Plan sta≈Çy'}</p></div>`;
    if(tempChange){
      html += `<button class="btn ghost" style="position:relative; min-width:120px; padding:6px 12px; white-space:nowrap; flex-shrink:0" onclick="removeTempChange('${dateStr}'); this.closest('.dialog-wrap').remove()">‚Ü∫ Przywr√≥ƒá</button>`;
    }
    html += `</div>`;
    
    if(lessons.length === 0){
      html += `<p style="color:var(--muted); text-align:center">Brak zajƒôƒá</p>`;
    } else {
      html += `<div style="display:flex; flex-direction:column; gap:8px">`;
      lessons.forEach(lesson => {
        const isZD = lesson.type === 'ZD';
        const badgeBg = isZD ? 'rgba(110,231,255,.25)' : 'rgba(139,92,246,.25)';
        const badgeColor = isZD ? '#6ee7ff' : '#b085f5';
        html += `<div style="background:#1a1e27; padding:8px; border-radius:8px; border:1px solid var(--border); font-size:12px">`;
        html += `<div style="display:flex; align-items:center; gap:6px; margin-bottom:4px">`;
        html += `<span style="color:var(--text); font-weight:700">${lesson.startTime}‚Äì${lesson.endTime}</span>`;
        html += `<span style="background:${badgeBg}; color:${badgeColor}; padding:1px 5px; border-radius:3px; font-size:10px; font-weight:700">${lesson.type}</span>`;
        html += `<span style="color:var(--text); font-weight:600">${lesson.student}</span>`;
        html += `</div>`;
        if(lesson.note) html += `<div style="color:var(--muted); font-size:11px; font-style:italic; word-break:break-word; word-wrap:break-word; overflow-wrap:break-word">${lesson.note}</div>`;
        html += `</div>`;
      });
      html += `</div>`;
    }
    
    html += `<div class="footer" style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap">`;
    html += `<button class="btn ghost" onclick="this.closest('.dialog-wrap').remove()">Zamknij</button>`;
    html += `<button class="btn primary" onclick="this.closest('.dialog-wrap').remove(); openTempChangeForDate('${dateStr}')">‚öô Zmiana</button>`;
    html += `</div>`;
    
    dialog.innerHTML = html;
    popup.appendChild(dialog);
    
    popup.addEventListener('click', (e) => {
      if(e.target === popup) popup.remove();
    });
    
    document.body.appendChild(popup);
  }
  
  function removeTempChange(dateStr){
    const tempChanges = loadTempChanges();
    const filtered = tempChanges.filter(tc => tc.date !== dateStr);
    localStorage.setItem(tempChangesKey, JSON.stringify(filtered));
    renderWeek();
    renderMonthCalendar();
  }
  
  function openTempChangeForDate(dateStr){
    const parts = dateStr.split('-');
    const year = parseInt(parts[0]);
    const month = parseInt(parts[1]) - 1;
    const day = parseInt(parts[2]);
    
    selectedTempChangeDate = new Date(year, month, day);
    tempChangeFromDayPopup = true;
    
    el('tempChangeStep1').style.display = 'none';
    el('tempChangeStep2').style.display = 'block';
    el('tempChangeSaveBtn').style.display = 'block';
    el('tempChangeCancelBtn').textContent = 'Zamknij';
    
    el('tempChangePlanWrap').style.display = 'flex';
    
    // Load and display the lessons for this day
    showTempChangeStep2(selectedTempChangeDate);
  }

  // ===== EDIT STATIC PLAN FUNCTIONS =====
  let selectedEditPlanDay = null;
  
  function openEditStaticPlanPopup(){
    const plan = loadStaticPlan();
    const selector = el('editPlanDaySelector');
    const today = getTodayFromMonday();
    if(!selector) return;
    
    selectedEditPlanDay = null;
    selector.innerHTML = '';
    el('editPlanStep1').style.display = 'block';
    el('editPlanStep2').style.display = 'none';
    el('editPlanCancel').style.display = 'block';
    el('editPlanBack').style.display = 'none';
    el('editPlanSave').style.display = 'none';
    
    plan.forEach(dayData => {
      const btn = document.createElement('button');
      btn.className = 'editPlanDayButton';
      if(dayData.dayNum === today) btn.classList.add('today');
      btn.innerHTML = `<div>${dayData.day}</div><div style="font-size:12px; color:var(--muted); margin-top:4px">${dayData.lessons.length} lekcji</div>`;
      btn.onclick = () => editStaticPlanStep2(dayData.dayNum);
      selector.appendChild(btn);
    });
    
    el('editPlanWrap').style.display = 'flex';
  }
  
  function editStaticPlanStep2(dayNum){
    const plan = loadStaticPlan();
    const dayData = plan.find(d => d.dayNum === dayNum);
    if(!dayData) return;
    
    selectedEditPlanDay = dayNum;
    const container = el('editPlanDayContainer');
    container.innerHTML = '';
    
    const col = document.createElement('div');
    col.className = 'dayColumn';
    col.innerHTML = `<h3>${dayData.day}</h3>`;
    
    const lessonsList = document.createElement('div');
    lessonsList.style.display = 'flex';
    lessonsList.style.flexDirection = 'column';
    lessonsList.style.gap = '8px';
    
    dayData.lessons.forEach(lesson => {
      const row = createLessonRowHTML(dayData.dayNum, lesson);
      lessonsList.appendChild(row);
    });
    
    // Add new lesson button
    const addBtn = document.createElement('button');
    addBtn.className = 'addLessonBtn';
    addBtn.textContent = '+ Dodaj lekcjƒô';
    addBtn.onclick = () => {
      const newRow = createLessonRowHTML(dayNum, {id: uid(), startTime: '10:00', endTime: '11:00', type: 'ST', student: '', note: ''});
      lessonsList.insertBefore(newRow, addBtn);
    };
    
    lessonsList.appendChild(addBtn);
    col.appendChild(lessonsList);
    container.appendChild(col);
    
    el('editPlanStep1').style.display = 'none';
    el('editPlanStep2').style.display = 'block';
    el('editPlanCancel').style.display = 'none';
    el('editPlanBack').style.display = 'block';
    el('editPlanSave').style.display = 'block';
  }
  
  function goBackToEditPlanStep1(){
    el('editPlanStep1').style.display = 'block';
    el('editPlanStep2').style.display = 'none';
    el('editPlanCancel').style.display = 'block';
    el('editPlanBack').style.display = 'none';
    el('editPlanSave').style.display = 'none';
    selectedEditPlanDay = null;
  }

  function createLessonRowHTML(dayNum, lesson){
    // Calculate duration in minutes from start and end time
    let duration = 60;
    if(lesson.startTime && lesson.endTime){
      const start = new Date(`2000-01-01T${lesson.startTime}`);
      const end = new Date(`2000-01-01T${lesson.endTime}`);
      duration = Math.round((end - start) / 60000);
    }
    
    const row = document.createElement('div');
    row.className = 'lessonRow';
    row.dataset.lessonId = lesson.id;
    row.dataset.dayNum = dayNum;
    
    row.innerHTML = `
      <div class="lessonRowTime">
        <input type="time" value="${lesson.startTime}" class="lessonStart" />
        <div class="durationButtonGroup" data-duration="${duration}">
          <button type="button" class="durationBtn ${duration === 60 ? 'active' : ''}" data-duration="60">60</button>
          <button type="button" class="durationBtn ${duration === 90 ? 'active' : ''}" data-duration="90">90</button>
          <button type="button" class="durationBtn ${duration === 120 ? 'active' : ''}" data-duration="120">120</button>
          <button type="button" class="durationBtn ${duration === 150 ? 'active' : ''}" data-duration="150">150</button>
          <button type="button" class="durationBtn ${duration === 180 ? 'active' : ''}" data-duration="180">180</button>
        </div>
      </div>
      <div class="lessonRowTypeStudent">
        <div class="typeButtonGroup">
          <button type="button" class="typeBtn st ${lesson.type === 'ST' ? 'active' : ''}" data-type="ST">ST</button>
          <button type="button" class="typeBtn zd ${lesson.type === 'ZD' ? 'active' : ''}" data-type="ZD">ZD</button>
        </div>
        <input type="text" class="lessonStudentInput" value="${lesson.student}" placeholder="Imiƒô" />
      </div>
      <input type="text" class="lessonNoteInput" value="${lesson.note}" placeholder="Notatka" />
      <div class="lessonRowActions">
        <button type="button" class="deleteBtn">‚úï Usu≈Ñ lekcjƒô</button>
      </div>
    `;
    
    // Setup type button handlers
    const stBtn = row.querySelector('.typeBtn.st');
    const zdBtn = row.querySelector('.typeBtn.zd');
    
    stBtn.addEventListener('click', () => {
      stBtn.classList.add('active');
      zdBtn.classList.remove('active');
    });
    
    zdBtn.addEventListener('click', () => {
      zdBtn.classList.add('active');
      stBtn.classList.remove('active');
    });
    
    // Setup duration button handlers
    const durationGroup = row.querySelector('.durationButtonGroup');
    const durationBtns = row.querySelectorAll('.durationBtn');
    
    durationBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        durationBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        durationGroup.dataset.duration = btn.dataset.duration;
      });
    });
    
    // Setup delete button
    row.querySelector('.deleteBtn').addEventListener('click', () => {
      row.remove();
    });
    
    return row;
  }

  function saveEditStaticPlan(){
    if(!selectedEditPlanDay) return;
    
    const plan = loadStaticPlan();
    const dayData = plan.find(d => d.dayNum === selectedEditPlanDay);
    if(!dayData) return;
    
    const container = el('editPlanDayContainer');
    dayData.lessons = [];
    const rows = container.querySelectorAll('.lessonRow');
    
    rows.forEach(row => {
      const startTime = row.querySelector('.lessonStart').value;
      const duration = parseInt(row.querySelector('.durationButtonGroup').dataset.duration) || 60;
      const activeTypeBtn = row.querySelector('.typeBtn.active');
      const type = activeTypeBtn ? activeTypeBtn.dataset.type : 'ST';
      const student = row.querySelector('.lessonStudentInput').value;
      const note = row.querySelector('.lessonNoteInput').value;
      
      if(student.trim() && startTime){
        // Calculate end time from start time + duration
        const start = new Date(`2000-01-01T${startTime}`);
        start.setMinutes(start.getMinutes() + duration);
        const endTime = `${String(start.getHours()).padStart(2, '0')}:${String(start.getMinutes()).padStart(2, '0')}`;
        
        dayData.lessons.push({
          id: row.dataset.lessonId,
          startTime,
          endTime,
          type,
          student,
          note
        });
      }
    });
    
    // Sort by time
    dayData.lessons.sort((a, b) => a.startTime.localeCompare(b.startTime));
    
    localStorage.setItem(staticPlanKey, JSON.stringify(plan));
    el('editPlanWrap').style.display = 'none';
    selectedEditPlanDay = null;
    renderWeek();
    renderMonthCalendar();
  }

  // Close edit plan popup
  el('editPlanCancel')?.addEventListener('click', () => {
    el('editPlanWrap').style.display = 'none';
    selectedEditPlanDay = null;
  });

  el('editPlanBack')?.addEventListener('click', goBackToEditPlanStep1);

  el('editPlanSave')?.addEventListener('click', () => {
    saveEditStaticPlan();
  });

  // ===== ADD TEMP CHANGE FUNCTIONS =====
  let selectedTempChangeDate = null;
  let calendarDisplayMonth = new Date().getMonth();
  let calendarDisplayYear = new Date().getFullYear();

  function renderTempChangeCalendar(year, month){
    const monthNames = ['Stycze≈Ñ','Luty','Marzec','Kwiecie≈Ñ','Maj','Czerwiec','Lipiec','Sierpie≈Ñ','Wrzesie≈Ñ','Pa≈∫dziernik','Listopad','Grudzie≈Ñ'];
    el('calendarMonth').textContent = monthNames[month];
    el('calendarYear').textContent = year;
    
    const container = el('miniCalendar');
    container.innerHTML = '';
    const today = new Date();
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startDate = new Date(firstDay);
    const offset = (firstDay.getDay() - 1 + 7) % 7;
    startDate.setDate(startDate.getDate() - offset);
    
    for(let i = 0; i < 42; i++){
      const date = new Date(startDate);
      date.setDate(date.getDate() + i);
      
      const btn = document.createElement('button');
      btn.textContent = date.getDate();
      
      if(date.getMonth() !== month) btn.classList.add('other-month');
      if(date.toDateString() === today.toDateString()) btn.classList.add('today');
      if(selectedTempChangeDate && date.toDateString() === selectedTempChangeDate.toDateString()) btn.classList.add('selected');
      
      btn.onclick = () => {
        selectedTempChangeDate = new Date(date);
        renderTempChangeCalendar(year, month);
        showTempChangeStep2(selectedTempChangeDate);
      };
      
      container.appendChild(btn);
    }
  }

  function openAddTempChangePopup(){
    selectedTempChangeDate = null;
    calendarDisplayMonth = new Date().getMonth();
    calendarDisplayYear = new Date().getFullYear();
    
    el('tempChangeStep1').style.display = 'block';
    el('tempChangeStep2').style.display = 'none';
    el('tempChangeSaveBtn').style.display = 'none';
    
    renderTempChangeCalendar(calendarDisplayYear, calendarDisplayMonth);
    el('tempChangePlanWrap').style.display = 'flex';
  }

  function showTempChangeStep2(date){
    const step1 = el('tempChangeStep1');
    const step2 = el('tempChangeStep2');
    const dayNum = date.getDay() === 0 ? 7 : date.getDay();
    const staticPlan = loadStaticPlan();
    const dayData = staticPlan.find(d => d.dayNum === dayNum);
    const tempChanges = loadTempChanges();
    const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
    const existingChange = tempChanges.find(tc => tc.date === dateStr);
    
    const container = el('tempChangeDayContainer');
    container.innerHTML = '';
    
    if(!dayData) return;
    
    const col = document.createElement('div');
    col.className = 'dayColumn';
    col.innerHTML = `<h3>${dayData.day} (${dateStr})</h3>`;
    
    const lessonsList = document.createElement('div');
    lessonsList.style.display = 'flex';
    lessonsList.style.flexDirection = 'column';
    lessonsList.style.gap = '8px';
    
    const lessonsToEdit = existingChange?.lessons || dayData.lessons;
    lessonsToEdit.forEach(lesson => {
      const row = createLessonRowHTML(dayNum, lesson);
      lessonsList.appendChild(row);
    });
    
    const addBtn = document.createElement('button');
    addBtn.className = 'addLessonBtn';
    addBtn.textContent = '+ Dodaj lekcjƒô';
    addBtn.onclick = () => {
      const newRow = createLessonRowHTML(dayNum, {id: uid(), startTime: '10:00', endTime: '11:00', type: 'ST', student: '', note: ''});
      lessonsList.insertBefore(newRow, addBtn);
    };
    
    lessonsList.appendChild(addBtn);
    col.appendChild(lessonsList);
    container.appendChild(col);
    
    step1.style.display = 'none';
    step2.style.display = 'block';
    el('tempChangeSaveBtn').style.display = 'block';
    el('tempChangeCancelBtn').textContent = el('tempChangeCancelBtn').dataset.step2;
  }

  function backToTempChangeCalendar(){
    el('tempChangeStep1').style.display = 'block';
    el('tempChangeStep2').style.display = 'none';
    el('tempChangeSaveBtn').style.display = 'none';
    el('tempChangeCancelBtn').textContent = el('tempChangeCancelBtn').dataset.step1;
  }

  function saveTempChange(){
    if(!selectedTempChangeDate) return;
    
    const dayNum = selectedTempChangeDate.getDay() === 0 ? 7 : selectedTempChangeDate.getDay();
    const dateStr = `${selectedTempChangeDate.getFullYear()}-${String(selectedTempChangeDate.getMonth() + 1).padStart(2, '0')}-${String(selectedTempChangeDate.getDate()).padStart(2, '0')}`;
    const container = el('tempChangeDayContainer');
    
    const lessons = [];
    const rows = container.querySelectorAll('.lessonRow');
    
    rows.forEach(row => {
      const startTime = row.querySelector('.lessonStart').value;
      const duration = parseInt(row.querySelector('.durationButtonGroup').dataset.duration) || 60;
      const activeTypeBtn = row.querySelector('.typeBtn.active');
      const type = activeTypeBtn ? activeTypeBtn.dataset.type : 'ST';
      const student = row.querySelector('.lessonStudentInput').value;
      const note = row.querySelector('.lessonNoteInput').value;
      
      if(student.trim() && startTime){
        // Calculate end time from start time + duration
        const start = new Date(`2000-01-01T${startTime}`);
        start.setMinutes(start.getMinutes() + duration);
        const endTime = `${String(start.getHours()).padStart(2, '0')}:${String(start.getMinutes()).padStart(2, '0')}`;
        
        lessons.push({
          id: row.dataset.lessonId,
          startTime,
          endTime,
          type,
          student,
          note
        });
      }
    });
    
    lessons.sort((a, b) => a.startTime.localeCompare(b.startTime));
    
    const tempChanges = loadTempChanges();
    const idx = tempChanges.findIndex(tc => tc.date === dateStr);
    
    if(idx >= 0) tempChanges[idx] = {date: dateStr, lessons};
    else tempChanges.push({date: dateStr, lessons});
    
    localStorage.setItem(tempChangesKey, JSON.stringify(tempChanges));
    el('tempChangePlanWrap').style.display = 'none';
    renderWeek();
    renderMonthCalendar();
  }

  el('tempChangeCancelBtn')?.addEventListener('click', () => {
    if(tempChangeFromDayPopup){
      // When opened from day popup, always close
      el('tempChangePlanWrap').style.display = 'none';
      tempChangeFromDayPopup = false;
    } else if(el('tempChangeStep2').style.display === 'block'){
      backToTempChangeCalendar();
    }else{
      el('tempChangePlanWrap').style.display = 'none';
    }
  });

  el('tempChangeSaveBtn')?.addEventListener('click', () => {
    saveTempChange();
  });

  el('prevMonthBtn')?.addEventListener('click', () => {
    calendarDisplayMonth--;
    if(calendarDisplayMonth < 0){
      calendarDisplayMonth = 11;
      calendarDisplayYear--;
    }
    renderTempChangeCalendar(calendarDisplayYear, calendarDisplayMonth);
  });

  el('nextMonthBtn')?.addEventListener('click', () => {
    calendarDisplayMonth++;
    if(calendarDisplayMonth > 11){
      calendarDisplayMonth = 0;
      calendarDisplayYear++;
    }
    renderTempChangeCalendar(calendarDisplayYear, calendarDisplayMonth);
  });

  // Close popups on background click
  el('editPlanWrap')?.addEventListener('click', (e) => {
    if(e.target === el('editPlanWrap')) el('editPlanWrap').style.display = 'none';
  });

  el('tempChangePlanWrap')?.addEventListener('click', (e) => {
    if(e.target === el('tempChangePlanWrap')) el('tempChangePlanWrap').style.display = 'none';
  });

  // Event listeners for buttons
  el('editStaticPlanBtn')?.addEventListener('click', openEditStaticPlanPopup);
  el('addTempChangeBtn')?.addEventListener('click', openAddTempChangePopup);

  // Monthly calendar navigation
  el('prevMonthCal')?.addEventListener('click', () => {
    monthCalendarState.month--;
    if(monthCalendarState.month < 0){
      monthCalendarState.month = 11;
      monthCalendarState.year--;
    }
    renderMonthCalendar();
  });

  el('nextMonthCal')?.addEventListener('click', () => {
    monthCalendarState.month++;
    if(monthCalendarState.month > 11){
      monthCalendarState.month = 0;
      monthCalendarState.year++;
    }
    renderMonthCalendar();
  });

  // Render week when switching to terminy tab
  el('terminyTab')?.addEventListener('click', ()=>{
    setTimeout(()=>{ renderWeek(); renderMonthCalendar(); }, 50);
  });

  // Initial render on load if terminy is visible
  if(currentView === 'students'){
    setTimeout(()=>{ renderWeek(); renderMonthCalendar(); }, 100);
  } else {
    // Render calendar on page load
    renderMonthCalendar();
  }
  </script>
</body>
</html>
